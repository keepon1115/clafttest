<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ジブンクラフト - 冒険者プロフィール編集</title>
    
    <!-- キャッシュ制御 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- PWA関連メタタグ -->
    <meta name="theme-color" content="#29B6F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CLAFT">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="manifest" href="manifest.json">
    
    <!-- フォントとスタイル -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;900&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/navigation.css">
    <link rel="stylesheet" href="css/auth.css">
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
</head>
<body>
    <!-- ハンバーガーメニュー -->
    <div class="hamburger-menu" id="hamburgerMenu">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </div>

    <!-- サイドバー -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">🎮 CLAFT</div>
        </div>
        <div class="sidebar-nav">
            <ul>
                <li><a href="index.html"><i class="fas fa-home"></i><span class="nav-label">ホーム</span></a></li>
                <li><a href="quest.html"><i class="fas fa-map"></i><span class="nav-label">クエストマップ</span></a></li>
                <li><a href="yononaka.html"><i class="fas fa-globe"></i><span class="nav-label">Yononaka</span></a></li>
                <li><a href="mirai.html"><i class="fas fa-rocket"></i><span class="nav-label">ミライクラフト</span></a></li>
            </ul>
        </div>
    </nav>

    <!-- オーバーレイ -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- 認証ボタン用スペース -->
    <div class="nav-buttons"></div>

    <!-- 背景の部屋 -->
    <div class="room-background">
        <div class="window">
            <div class="sun"></div>
            <div class="cloud cloud1"></div>
        </div>
        <div class="floor"></div>
        <div class="bookshelf">
            <div class="book"></div>
            <div class="book"></div>
            <div class="book"></div>
            <div class="book"></div>
            <div class="book"></div>
        </div>
        <div class="plant">
            <div class="pot"></div>
            <div class="leaf"></div>
            <div class="leaf"></div>
            <div class="leaf"></div>
        </div>
    </div>

    <!-- ヘッダー -->
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="back-button">
                <i class="fas fa-arrow-left"></i>
                ホームに戻る
            </a>
            <div class="header-title">
                <h1>🎮 ジブンクラフト</h1>
                <p>冒険者プロフィールをカスタマイズしよう！</p>
            </div>
            <div class="save-indicator" id="saveIndicator">
                <i class="fas fa-check-circle"></i>
                <span>保存済み</span>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="main-container">
        <!-- キャラクタープレビュー -->
        <aside class="character-preview">
            <div class="preview-card">
                <div class="character-avatar">
                    <div class="avatar-circle" id="avatarCircle">
                        <input type="file" id="avatarInput" class="avatar-input" accept="image/*">
                        <img id="avatarImage" src="images/default-avatar.png" alt="プロフィール画像">
                        <div class="upload-icon">
                            <i class="fas fa-camera"></i>
                        </div>
                        <div class="upload-progress" id="uploadProgress"></div>
                    </div>
                    <div class="character-speech" id="characterSpeech">
                        <span id="speechText">よろしく！</span>
                    </div>
                </div>
                <h2 class="character-name" id="displayName">たろう</h2>
                
                <div class="character-stats">
                    <div class="stat-item">
                        <div class="stat-label">キャラ特性</div>
                        <div class="stat-value" id="displayCharacter">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">とくいスキル</div>
                        <div class="stat-value" id="displaySkill">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">すきな場所</div>
                        <div class="stat-value" id="displayPlace">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">仲間タイプ</div>
                        <div class="stat-value" id="displayCompanion">-</div>
                    </div>
                </div>
                
                <div class="completion-bar">
                    <div class="completion-fill" id="completionFill" style="width: 20%">
                        <div class="completion-text" id="completionText">20% 完成</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 編集フォーム -->
        <section class="edit-form">
            <div class="form-tabs">
                <button class="tab-button active" data-tab="basic">
                    <i class="fas fa-user"></i> 基本情報
                </button>
                <button class="tab-button" data-tab="ability">
                    <i class="fas fa-star"></i> 能力設定
                </button>
                <button class="tab-button" data-tab="preference">
                    <i class="fas fa-heart"></i> 好み設定
                </button>
                <button class="tab-button" data-tab="social">
                    <i class="fas fa-users"></i> 仲間設定
                </button>
                <button class="tab-button" data-tab="message">
                    <i class="fas fa-comment"></i> メッセージ
                </button>
            </div>

            <!-- 基本情報タブ -->
            <div class="tab-content active" id="basic-tab">
                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">👤</span>
                        ニックネーム
                        <span class="help-tooltip">
                            <i class="fas fa-question"></i>
                            <span class="tooltip-content">冒険で呼ばれる名前だよ！</span>
                        </span>
                    </label>
                    <input type="text" class="form-input" id="nickname" placeholder="例：たろう" maxlength="10">
                    <div class="character-limit">
                        <span id="nicknameCount">0</span> / 10文字
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">✨</span>
                        キャラ（特性）
                        <span class="help-tooltip">
                            <i class="fas fa-question"></i>
                            <span class="tooltip-content">どんな冒険者タイプ？</span>
                        </span>
                    </label>
                    <div class="choice-buttons">
                        <button class="choice-button" data-character="勇者">⚔️ 勇者</button>
                        <button class="choice-button" data-character="魔法使い">🪄 魔法使い</button>
                        <button class="choice-button" data-character="探検家">🗺️ 探検家</button>
                        <button class="choice-button" data-character="発明家">🔧 発明家</button>
                        <button class="choice-button" data-character="芸術家">🎨 芸術家</button>
                        <button class="choice-button" data-character="学者">📚 学者</button>
                    </div>
                    <input type="text" class="form-input" id="character" placeholder="その他の特性を入力" style="margin-top: 10px;">
                </div>
            </div>

            <!-- 能力設定タブ -->
            <div class="tab-content" id="ability-tab">
                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">💪</span>
                        とくい（スキル）
                        <span class="help-tooltip">
                            <i class="fas fa-question"></i>
                            <span class="tooltip-content">得意なことを3つまで！</span>
                        </span>
                    </label>
                    <div class="choice-buttons">
                        <button class="choice-button skill-button" data-skill="プログラミング">💻 プログラミング</button>
                        <button class="choice-button skill-button" data-skill="デザイン">🎨 デザイン</button>
                        <button class="choice-button skill-button" data-skill="スポーツ">⚽ スポーツ</button>
                        <button class="choice-button skill-button" data-skill="音楽">🎵 音楽</button>
                        <button class="choice-button skill-button" data-skill="料理">🍳 料理</button>
                        <button class="choice-button skill-button" data-skill="コミュニケーション">💬 コミュニケーション</button>
                    </div>
                    <input type="text" class="form-input" id="skills" placeholder="その他のスキルを入力（カンマ区切り）" style="margin-top: 10px;">
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">😅</span>
                        よわみ（苦手）
                        <span class="help-tooltip">
                            <i class="fas fa-question"></i>
                            <span class="tooltip-content">苦手なことも個性だよ！</span>
                        </span>
                    </label>
                    <textarea class="form-textarea" id="weakness" placeholder="例：朝起きるのが苦手、片付けが続かない" maxlength="50"></textarea>
                    <div class="character-limit">
                        <span id="weaknessCount">0</span> / 50文字
                    </div>
                </div>
            </div>

            <!-- 好み設定タブ -->
            <div class="tab-content" id="preference-tab">
                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">🏖️</span>
                        すきな時間・場所
                        <span class="help-tooltip">
                            <i class="fas fa-question"></i>
                            <span class="tooltip-content">落ち着く場所や時間帯！</span>
                        </span>
                    </label>
                    <div class="choice-buttons">
                        <button class="choice-button place-button" data-place="カフェ">☕ カフェ</button>
                        <button class="choice-button place-button" data-place="図書館">📚 図書館</button>
                        <button class="choice-button place-button" data-place="公園">🌳 公園</button>
                        <button class="choice-button place-button" data-place="家">🏠 家</button>
                        <button class="choice-button place-button" data-place="夜の時間">🌙 夜の時間</button>
                        <button class="choice-button place-button" data-place="朝の時間">🌅 朝の時間</button>
                    </div>
                    <input type="text" class="form-input" id="favoritePlace" placeholder="その他の場所・時間を入力" style="margin-top: 10px;">
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">⚡</span>
                        エネルギーチャージ方法
                        <span class="help-tooltip">
                            <i class="fas fa-question"></i>
                            <span class="tooltip-content">元気になる方法！</span>
                        </span>
                    </label>
                    <textarea class="form-textarea" id="energyCharge" placeholder="例：好きな音楽を聴く、散歩する、友達と話す" maxlength="100"></textarea>
                    <div class="character-limit">
                        <span id="energyChargeCount">0</span> / 100文字
                    </div>
                </div>
            </div>

            <!-- 仲間設定タブ -->
            <div class="tab-content" id="social-tab">
                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">🤝</span>
                        一緒に冒険したい人
                        <span class="help-tooltip">
                            <i class="fas fa-question"></i>
                            <span class="tooltip-content">どんな仲間と冒険したい？</span>
                        </span>
                    </label>
                    <div class="choice-buttons">
                        <button class="choice-button companion-button" data-companion="リーダータイプ">👑 リーダータイプ</button>
                        <button class="choice-button companion-button" data-companion="サポータータイプ">🛡️ サポータータイプ</button>
                        <button class="choice-button companion-button" data-companion="ムードメーカー">🎭 ムードメーカー</button>
                        <button class="choice-button companion-button" data-companion="アイデアマン">💡 アイデアマン</button>
                        <button class="choice-button companion-button" data-companion="冷静な分析家">🧐 冷静な分析家</button>
                        <button class="choice-button companion-button" data-companion="行動派">🏃 行動派</button>
                    </div>
                    <input type="text" class="form-input" id="companion" placeholder="その他のタイプを入力" style="margin-top: 10px;">
                </div>
            </div>

            <!-- メッセージタブ -->
            <div class="tab-content" id="message-tab">
                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">💭</span>
                        セリフ
                        <span class="help-tooltip">
                            <i class="fas fa-question"></i>
                            <span class="tooltip-content">キャラクターの口ぐせ！</span>
                        </span>
                    </label>
                    <input type="text" class="form-input" id="catchphrase" placeholder="例：よろしく！一緒に頑張ろう！" maxlength="30">
                    <div class="character-limit">
                        <span id="catchphraseCount">0</span> / 30文字
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">📝</span>
                        ひとこと
                        <span class="help-tooltip">
                            <i class="fas fa-question"></i>
                            <span class="tooltip-content">自己紹介メッセージ！</span>
                        </span>
                    </label>
                    <textarea class="form-textarea" id="message" placeholder="例：プログラミングが大好きな冒険者です！みんなで楽しく学びながら成長したいです。" maxlength="200"></textarea>
                    <div class="character-limit">
                        <span id="messageCount">0</span> / 200文字
                    </div>
                </div>
            </div>

            <!-- アクションボタン -->
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="cancelEdit()">
                    <i class="fas fa-times"></i> キャンセル
                </button>
                <button class="btn btn-primary" onclick="saveProfile()">
                    <i class="fas fa-save"></i> 保存する
                </button>
            </div>
        </section>
    </main>

    <!-- 実績モーダル -->
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="achievement-modal" id="achievementModal">
        <div class="achievement-icon">🏆</div>
        <h3 class="achievement-title">プロフィール完成！</h3>
        <p class="achievement-description">素晴らしい冒険者プロフィールができました！</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/auth.js"></script>
    <script>
        // 状態管理
        let profileData = {
            nickname: 'たろう',
            character: '',
            skills: [],
            weakness: '',
            favoritePlace: '',
            energyCharge: '',
            companion: '',
            catchphrase: '',
            message: ''
        };

        let currentUser = null;
        let isLoading = false;

        // 認証状態が変更されたときの処理
        window.onAuthStateChanged = async function(user) {
            currentUser = user;
            if (user) {
                // ログイン時：プロフィールデータを読み込む
                await loadProfileFromSupabase();
            } else {
                // 未ログイン時：認証モーダルを表示
                authManager.showAuthModal();
            }
        };

        // ページ初期化時の処理を更新
        document.addEventListener('DOMContentLoaded', function() {
            // タブ切り替え
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    switchTab(targetTab);
                });
            });

            // 入力イベントリスナー
            setupInputListeners();
            
            // 選択ボタンのイベントリスナー
            setupChoiceButtons();
            
            // 自動保存（Supabaseに）
            setInterval(autoSave, 30000); // 30秒ごとに自動保存
            
            // 認証チェック
            const user = authManager.getCurrentUser();
            if (!user) {
                // 未ログインの場合は認証モーダルを表示
                setTimeout(() => {
                    authManager.showAuthModal();
                }, 500);
            }
        });

        // タブ切り替え
        function switchTab(tabName) {
            // タブボタンのアクティブ状態を更新
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // タブコンテンツの表示切り替え
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // 入力イベントリスナーの設定
        function setupInputListeners() {
            // ニックネーム
            const nicknameInput = document.getElementById('nickname');
            nicknameInput.addEventListener('input', function() {
                profileData.nickname = this.value || 'たろう';
                updateCharacterDisplay();
                updateCharacterLimit('nickname', this.value.length, 10);
            });

            // キャラクター特性
            const characterInput = document.getElementById('character');
            characterInput.addEventListener('input', function() {
                updateCharacterDisplay();
            });

            // その他の入力フィールド
            const fields = ['skills', 'weakness', 'favoritePlace', 'energyCharge', 'companion', 'catchphrase', 'message'];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.addEventListener('input', function() {
                        profileData[field] = this.value;
                        updateCharacterDisplay();
                        
                        // 文字数カウント更新
                        if (element.maxLength) {
                            updateCharacterLimit(field, this.value.length, element.maxLength);
                        }
                    });
                }
            });
        }

        // 選択ボタンのイベントリスナー設定
        function setupChoiceButtons() {
            // キャラクター選択
            document.querySelectorAll('[data-character]').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('[data-character]').forEach(btn => btn.classList.remove('selected'));
                    this.classList.add('selected');
                    profileData.character = this.getAttribute('data-character');
                    document.getElementById('character').value = profileData.character;
                    updateCharacterDisplay();
                });
            });

            // スキル選択（複数選択可）
            document.querySelectorAll('.skill-button').forEach(button => {
                button.addEventListener('click', function() {
                    const skill = this.getAttribute('data-skill');
                    if (this.classList.contains('selected')) {
                        this.classList.remove('selected');
                        profileData.skills = profileData.skills.filter(s => s !== skill);
                    } else if (profileData.skills.length < 3) {
                        this.classList.add('selected');
                        profileData.skills.push(skill);
                    } else {
                        showNotification('スキルは3つまで選択できます！');
                    }
                    updateSkillsInput();
                    updateCharacterDisplay();
                });
            });

            // 場所選択
            document.querySelectorAll('.place-button').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.place-button').forEach(btn => btn.classList.remove('selected'));
                    this.classList.add('selected');
                    profileData.favoritePlace = this.getAttribute('data-place');
                    document.getElementById('favoritePlace').value = profileData.favoritePlace;
                    updateCharacterDisplay();
                });
            });

            // 仲間選択
            document.querySelectorAll('.companion-button').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.companion-button').forEach(btn => btn.classList.remove('selected'));
                    this.classList.add('selected');
                    profileData.companion = this.getAttribute('data-companion');
                    document.getElementById('companion').value = profileData.companion;
                    updateCharacterDisplay();
                });
            });
        }

        // スキル入力フィールドの更新
        function updateSkillsInput() {
            document.getElementById('skills').value = profileData.skills.join(', ');
        }

        // キャラクター表示の更新
        function updateCharacterDisplay() {
            // 名前
            document.getElementById('displayName').textContent = profileData.nickname || 'たろう';
            
            // ステータス表示
            document.getElementById('displayCharacter').textContent = profileData.character || '-';
            document.getElementById('displaySkill').textContent = profileData.skills.length > 0 ? profileData.skills[0] : '-';
            document.getElementById('displayPlace').textContent = profileData.favoritePlace || '-';
            document.getElementById('displayCompanion').textContent = profileData.companion || '-';
            
            // セリフ
            if (profileData.catchphrase) {
                document.getElementById('speechText').textContent = profileData.catchphrase;
                document.getElementById('characterSpeech').classList.add('active');
            } else {
                document.getElementById('characterSpeech').classList.remove('active');
            }
            
            // アバターアイコンの更新
            updateAvatarIcon();
            
            // 完成度の更新
            updateCompletion();
        }

        // アバターアイコンの更新
        function updateAvatarIcon() {
            const avatarCircle = document.getElementById('avatarCircle');
            const iconMap = {
                '勇者': 'fa-shield-alt',
                '魔法使い': 'fa-hat-wizard',
                '探検家': 'fa-compass',
                '発明家': 'fa-cog',
                '芸術家': 'fa-palette',
                '学者': 'fa-book'
            };
            
            const iconClass = iconMap[profileData.character] || 'fa-user';
            avatarCircle.innerHTML = `<i class="fas ${iconClass}"></i>`;
        }

        // 完成度の計算と更新
        function updateCompletion() {
            const fields = ['nickname', 'character', 'skills', 'weakness', 'favoritePlace', 'energyCharge', 'companion', 'catchphrase', 'message'];
            let filledCount = 0;
            
            fields.forEach(field => {
                if (field === 'skills') {
                    if (profileData[field].length > 0) filledCount++;
                } else if (profileData[field] && profileData[field].trim() !== '') {
                    filledCount++;
                }
            });
            
            const percentage = Math.round((filledCount / fields.length) * 100);
            document.getElementById('completionFill').style.width = percentage + '%';
            document.getElementById('completionText').textContent = percentage + '% 完成';
            
            // 100%達成時の演出
            if (percentage === 100 && !sessionStorage.getItem('achievementShown')) {
                setTimeout(() => showAchievement(), 500);
                sessionStorage.setItem('achievementShown', 'true');
            }
        }

        // 文字数カウントの更新
        function updateCharacterLimit(fieldId, current, max) {
            const countElement = document.getElementById(fieldId + 'Count');
            if (countElement) {
                countElement.textContent = current;
                const limitElement = countElement.parentElement;
                
                if (current >= max) {
                    limitElement.classList.add('error');
                } else if (current >= max * 0.8) {
                    limitElement.classList.add('warning');
                } else {
                    limitElement.classList.remove('warning', 'error');
                }
            }
        }

        // 通知表示
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--yellow);
                color: var(--text-dark);
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: var(--shadow-soft);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 実績表示
        function showAchievement() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('achievementModal').classList.add('show');
            
            setTimeout(() => {
                document.getElementById('modalOverlay').classList.remove('show');
                document.getElementById('achievementModal').classList.remove('show');
            }, 3000);
        }

        // Supabaseからプロフィールを読み込む
        async function loadProfileFromSupabase() {
            const user = authManager.getCurrentUser();
            if (!user) return;

            showLoading(true);

            try {
                const { data: profile, error } = await supabase
                    .from('users_profile')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                if (profile) {
                    // プロフィールデータをprofileDataオブジェクトに設定
                    profileData = {
                        nickname: profile.nickname || '',
                        character: profile.character_type || '',
                        skills: profile.strengths || [],
                        weakness: profile.weaknesses ? profile.weaknesses.join('、') : '',
                        favoritePlace: profile.favorite_time_place || '',
                        energyCharge: profile.energy_charge_method || '',
                        companion: profile.adventure_partner || '',
                        catchphrase: profile.catchphrase || '',
                        message: profile.comment || ''
                    };

                    // フォームに値を設定
                    document.getElementById('nickname').value = profileData.nickname;
                    document.getElementById('character').value = profileData.character;
                    document.getElementById('skills').value = profileData.skills.join(', ');
                    document.getElementById('weakness').value = profileData.weakness;
                    document.getElementById('favoritePlace').value = profileData.favoritePlace;
                    document.getElementById('energyCharge').value = profileData.energyCharge;
                    document.getElementById('companion').value = profileData.companion;
                    document.getElementById('catchphrase').value = profileData.catchphrase;
                    document.getElementById('message').value = profileData.message;

                    // 選択ボタンの状態を復元
                    restoreSelectedButtons();

                    // 表示を更新
                    updateCharacterDisplay();
                }
            } catch (error) {
                console.error('プロフィール読み込みエラー:', error);
                showNotification('プロフィールの読み込みに失敗しました');
            } finally {
                showLoading(false);
            }
        }

        // フォームにデータを設定
        function populateForm() {
            document.getElementById('nickname').value = profileData.nickname || '';
            document.getElementById('character').value = profileData.character || '';
            document.getElementById('skills').value = Array.isArray(profileData.skills) ? profileData.skills.join(', ') : profileData.skills || '';
            document.getElementById('weakness').value = profileData.weakness || '';
            document.getElementById('favoritePlace').value = profileData.favoritePlace || '';
            document.getElementById('energyCharge').value = profileData.energyCharge || '';
            document.getElementById('companion').value = profileData.companion || '';
            document.getElementById('catchphrase').value = profileData.catchphrase || '';
            document.getElementById('message').value = profileData.message || '';
        }

        // 自動保存
        async function autoSave() {
            if (!currentUser || isLoading) return;
            
            const indicator = document.getElementById('saveIndicator');
            if (indicator) {
                indicator.classList.add('saving');
                indicator.querySelector('span').textContent = '自動保存中...';
            }
            
            try {
                await saveToSupabase(false); // サイレント保存
                if (indicator) {
                    indicator.classList.remove('saving');
                    indicator.querySelector('span').textContent = '自動保存済み';
                }
            } catch (error) {
                console.error('自動保存エラー:', error);
                if (indicator) {
                    indicator.classList.remove('saving');
                    indicator.querySelector('span').textContent = '保存エラー';
                }
            }
        }

        // Supabaseにプロフィールを保存
        async function saveToSupabase(showNotifications = true) {
            if (!currentUser) {
                if (showNotifications) showNotification('ログインが必要です');
                return false;
            }

            try {
                // スキルと弱みを配列に変換
                const strengthsArray = typeof profileData.skills === 'string' 
                    ? profileData.skills.split(',').map(s => s.trim()).filter(s => s)
                    : profileData.skills || [];
                
                const weaknessesArray = profileData.weakness 
                    ? profileData.weakness.split(',').map(s => s.trim()).filter(s => s)
                    : [];

                const profileUpdate = {
                    id: currentUser.id,
                    email: currentUser.email,
                    nickname: profileData.nickname || 'ユーザー',
                    character_type: profileData.character || null,
                    catchphrase: profileData.catchphrase || null,
                    strengths: strengthsArray,
                    weaknesses: weaknessesArray,
                    favorite_time_place: profileData.favoritePlace || null,
                    energy_charge_method: profileData.energyCharge || null,
                    adventure_partner: profileData.companion || null,
                    comment: profileData.message || null,
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('users_profile')
                    .upsert(profileUpdate, { 
                        onConflict: 'id',
                        ignoreDuplicates: false 
                    });

                if (error) throw error;

                if (showNotifications) {
                    showNotification('プロフィールを保存しました！');
                }
                
                return true;
            } catch (error) {
                console.error('プロフィール保存エラー:', error);
                if (showNotifications) {
                    showNotification('保存に失敗しました: ' + error.message);
                }
                return false;
            }
        }

        // 選択ボタンの状態を復元
        function restoreSelectedButtons() {
            // キャラクター
            if (profileData.character) {
                const charButton = document.querySelector(`[data-character="${profileData.character}"]`);
                if (charButton) charButton.classList.add('selected');
            }
            
            // スキル
            profileData.skills.forEach(skill => {
                const skillButton = document.querySelector(`[data-skill="${skill}"]`);
                if (skillButton) skillButton.classList.add('selected');
            });
            
            // 場所
            if (profileData.favoritePlace) {
                const placeButton = document.querySelector(`[data-place="${profileData.favoritePlace}"]`);
                if (placeButton) placeButton.classList.add('selected');
            }
            
            // 仲間
            if (profileData.companion) {
                const companionButton = document.querySelector(`[data-companion="${profileData.companion}"]`);
                if (companionButton) companionButton.classList.add('selected');
            }
        }

        // プロフィールをSupabaseに保存
        async function saveProfile() {
            const user = authManager.getCurrentUser();
            if (!user) {
                showNotification('ログインが必要です');
                authManager.showAuthModal();
                return;
            }

            showLoading(true);
            
            try {
                // フォームから最新のデータを取得
                profileData.nickname = document.getElementById('nickname').value || 'たろう';
                profileData.character = document.getElementById('character').value;
                profileData.weakness = document.getElementById('weakness').value;
                profileData.favoritePlace = document.getElementById('favoritePlace').value;
                profileData.energyCharge = document.getElementById('energyCharge').value;
                profileData.companion = document.getElementById('companion').value;
                profileData.catchphrase = document.getElementById('catchphrase').value;
                profileData.message = document.getElementById('message').value;
                
                // スキルの処理
                const skillsInput = document.getElementById('skills').value;
                if (skillsInput) {
                    profileData.skills = skillsInput.split(/[,、]/).map(s => s.trim()).filter(s => s);
                }

                // Supabaseに保存するデータ形式に変換
                const saveData = {
                    id: user.id,
                    email: user.email,
                    nickname: profileData.nickname,
                    character_type: profileData.character,
                    catchphrase: profileData.catchphrase,
                    strengths: profileData.skills,
                    weaknesses: profileData.weakness ? profileData.weakness.split(/[,、]/).map(s => s.trim()).filter(s => s) : [],
                    favorite_time_place: profileData.favoritePlace,
                    energy_charge_method: profileData.energyCharge,
                    adventure_partner: profileData.companion,
                    comment: profileData.message,
                    updated_at: new Date().toISOString()
                };

                // upsert（存在しなければ作成、存在すれば更新）
                const { data, error } = await supabase
                    .from('users_profile')
                    .upsert(saveData)
                    .select()
                    .single();

                if (error) throw error;

                showNotification('プロフィールを保存しました！');
                
                // 保存アニメーション
                const saveButton = document.querySelector('.btn-primary');
                saveButton.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    saveButton.style.transform = 'scale(1)';
                }, 200);

                // 完成度が100%の場合は実績を表示
                const percentage = parseInt(document.getElementById('completionText').textContent);
                if (percentage === 100) {
                    setTimeout(() => showAchievement(), 500);
                }

                // 自動保存インジケーターを更新
                updateSaveIndicator('saved');

            } catch (error) {
                console.error('保存エラー:', error);
                showNotification('保存に失敗しました: ' + error.message);
                updateSaveIndicator('error');
            } finally {
                showLoading(false);
            }
        }

        // 編集キャンセル
        function cancelEdit() {
            if (confirm('編集内容を破棄してホームに戻りますか？')) {
                window.location.href = 'index.html';
            }
        }

        // ローディング表示
        function showLoading(show) {
            let loadingEl = document.getElementById('loadingOverlay');
            
            if (!loadingEl) {
                loadingEl = document.createElement('div');
                loadingEl.id = 'loadingOverlay';
                loadingEl.className = 'loading-overlay';
                loadingEl.innerHTML = `
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <p>処理中...</p>
                    </div>
                `;
                loadingEl.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                `;
                document.body.appendChild(loadingEl);
            }
            
            loadingEl.style.display = show ? 'flex' : 'none';
        }

        // 保存インジケーターの更新
        function updateSaveIndicator(status) {
            const indicator = document.getElementById('saveIndicator');
            if (!indicator) return;
            
            switch(status) {
                case 'saving':
                    indicator.classList.add('saving');
                    indicator.querySelector('span').textContent = '保存中...';
                    indicator.querySelector('i').className = 'fas fa-spinner fa-spin';
                    break;
                case 'saved':
                    indicator.classList.remove('saving');
                    indicator.querySelector('span').textContent = '保存済み';
                    indicator.querySelector('i').className = 'fas fa-check-circle';
                    break;
                case 'error':
                    indicator.classList.remove('saving');
                    indicator.querySelector('span').textContent = '保存エラー';
                    indicator.querySelector('i').className = 'fas fa-exclamation-circle';
                    break;
            }
        }

        // 既存の関数を上書き
        window.saveToLocalStorage = function() {
            // 自動保存時もSupabaseに保存
            saveProfile();
        };

        window.loadFromLocalStorage = function() {
            // Supabaseから読み込み
            loadProfileFromSupabase();
        };

        // アニメーション用のCSS追加
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 4px solid #f3f3f3;
                border-top: 4px solid var(--blue);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .loading-content {
                text-align: center;
                color: white;
                font-size: 18px;
                font-weight: 500;
            }
        `;
        document.head.appendChild(style);
    </script>
    <script src="js/include.js"></script>
</body>
</html>