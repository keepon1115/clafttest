<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWAÈñ¢ÈÄ£„É°„Çø„Çø„Ç∞ -->
    <meta name="theme-color" content="#29B6F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CLAFT">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="manifest" href="manifest.json">
    <title>CLAFT „ÇØ„Ç®„Çπ„Éà„Éû„ÉÉ„Éó - ÂÜíÈô∫„ÅÆÊõ∏</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/navigation.css">
    <style>
        /* CSS„ÅØÂâçÂõû„Å®Â§âÊõ¥„Å™„Åó„ÅÆ„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØÁúÅÁï•„Åó„Åæ„Åô */
        /* (ÂÆüÈöõ„ÅÆ„Éï„Ç°„Ç§„É´„Åß„ÅØ„ÄÅÂâçÂõû„ÅÆCSS„Åå„Åì„Åì„Å´„Åù„ÅÆ„Åæ„ÅæÂÖ•„Çä„Åæ„Åô) */
        * { margin: 0; padding: 0; box-sizing: border-box; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; }
        body { font-family: 'DotGothic16', 'M PLUS Rounded 1c', sans-serif; line-height: 1.6; color: #2c2c2c; overflow-x: hidden; background: linear-gradient(to bottom, #87CEEB 0%, #98D8E8 50%, #B0E0E6 100%); min-height: 100vh; position: relative; padding-bottom: 100px; }
        .sky-object { position: fixed; opacity: 0.8; animation-timing-function: linear; animation-iteration-count: infinite; z-index: 1; pointer-events: none; }
        .cloud { width: 100px; height: 40px; background: white; border-radius: 100px; box-shadow: 20px 10px 0 10px white, -20px 10px 0 5px white; }
        .ufo { font-size: 40px; text-align: center; animation: ufo-wobble 3s ease-in-out infinite alternate; }
        .ufo::before { content: 'üõ∏'; }
        @keyframes ufo-wobble { from { transform: translateY(-3px) rotate(-2deg); } to { transform: translateY(3px) rotate(2deg); } }
        @keyframes float-sky-ltr { from { transform: translateX(0) translateY(var(--sy, 0)); } to { transform: translateX(calc(100vw + 200px)) translateY(var(--ey, 0)); } }
        @keyframes float-sky-rtl { from { transform: translateX(0) translateY(var(--sy, 0)); } to { transform: translateX(calc(-100vw - 200px)) translateY(var(--ey, 0)); } }

        .container { max-width: 1200px; margin: 0 auto; padding: 80px 16px 40px; position: relative; z-index: 10; }
        .map-header { text-align: center; margin-bottom: 30px; position: relative; }
        .map-header h1 { font-size: 2.5rem; color: #FFF; margin-bottom: 16px; text-shadow: 2px 2px 0 #4DB6F7, 4px 4px 0 #3A8BC4, 6px 6px 8px rgba(0,0,0,0.3); letter-spacing: 2px; animation: float_title 3s ease-in-out infinite; }
        @keyframes float_title { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .map-header p { font-size: 1.1rem; color: #FFF; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); background: rgba(0,0,0,0.2); display: inline-block; padding: 4px 16px; border-radius: 0; border: 2px solid rgba(255,255,255,0.3); }
        .adventure-log-button { display: inline-block; margin: 20px auto 0; padding: 12px 32px; background: #FFD700; border: 3px solid #B8860B; color: #654321; font-weight: bold; font-size: 1rem; cursor: pointer; position: relative; box-shadow: 0 0 0 1px #DAA520, 4px 4px 0 0 rgba(0,0,0,0.3); transition: all 0.1s ease; }
        .adventure-log-button::before { content: 'üìñ'; margin-right: 8px; }
        .adventure-log-button:hover { transform: translate(-2px, -2px); box-shadow: 0 0 0 1px #DAA520, 6px 6px 0 0 rgba(0,0,0,0.3); }
        .adventure-log-button:active { transform: translate(1px, 1px); box-shadow: 0 0 0 1px #DAA520, 2px 2px 0 0 rgba(0,0,0,0.3); }
        .stage-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 32px; margin-bottom: 40px; padding: 0 20px; }
        @media (max-width: 767px) { .stage-grid { grid-template-columns: repeat(2, 1fr); gap: 24px; padding: 0; } }
        .stage-node { position: relative; text-align: center; cursor: pointer; transition: transform 0.2s ease; }
        .stage-node:nth-child(2), .stage-node:nth-child(5) { transform: translateY(40px); }
        @media (max-width: 767px) { .stage-node:nth-child(even) { transform: translateY(40px); } .stage-node:nth-child(5) { transform: translateY(0); } }
        .stage-node:hover { transform: translateY(-5px) scale(1.05); }
        .stage-node:nth-child(2):hover, .stage-node:nth-child(5):hover { transform: translateY(35px) scale(1.05); }
        @media (max-width: 767px) { .stage-node:nth-child(even):hover { transform: translateY(35px) scale(1.05); } .stage-node:nth-child(5):hover { transform: translateY(-5px) scale(1.05); } }
        .stage-icon { width: 120px; height: 120px; margin: 0 auto 16px; position: relative; background: #E8F5E9; border: 4px solid #333; box-shadow: 0 0 0 2px #666, 6px 6px 0 0 rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 64px; transition: all 0.3s ease; overflow: hidden; }
        .stage-node.locked .stage-icon, .stage-node.current .stage-icon { background: #9E9E9E; }
        .stage-node.completed .stage-icon { background: #FFF9C4; box-shadow: 0 0 0 2px #FFD700, 6px 6px 0 0 rgba(0,0,0,0.3), 0 0 20px rgba(255,215,0,0.5); }
        .stage-icon img.icon-image { width: 64px; height: 64px; object-fit: contain; image-rendering: pixelated; display: block; transition: filter 0.3s ease; filter: grayscale(1); }
        .stage-node.completed .stage-icon img.icon-image { filter: grayscale(0); }
        .stage-node.locked .stage-icon img.icon-image { filter: grayscale(1); opacity: 0.7; }
        .stage-icon .icon-fallback { font-size: 64px; display: none; filter: grayscale(1); }
        .stage-node.completed .stage-icon .icon-fallback { filter: grayscale(0); }
        .stage-node.locked .stage-icon .icon-fallback { filter: grayscale(1); opacity: 0.7; }
        .clear-effect { position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; object-fit: contain; display: none; z-index: 2; animation: effect-animation 2s ease-in-out infinite; }
        .stage-node.completed .clear-effect { display: block; }
        @keyframes effect-animation { 0%, 100% { transform: translateY(0) scale(1) rotate(0deg); opacity: 0.9; } 25% { transform: translateY(-5px) scale(1.1) rotate(5deg); opacity: 1; } 50% { transform: translateY(0) scale(1) rotate(0deg); opacity: 0.9; } 75% { transform: translateY(-3px) scale(1.05) rotate(-5deg); opacity: 1; } }
        .clear-badge { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background: #FFD700; border: 3px solid #B8860B; padding: 4px 12px; font-weight: bold; font-size: 14px; color: #654321; letter-spacing: 1px; box-shadow: 0 0 0 1px #DAA520, 3px 3px 0 0 rgba(0,0,0,0.5); z-index: 10; animation: bounce-in 0.5s ease; display: none; }
        .stage-node.completed .clear-badge { display: block; }
        @keyframes bounce-in { 0% { transform: translateX(-50%) translateY(-20px) scale(0); } 50% { transform: translateX(-50%) translateY(0) scale(1.2); } 100% { transform: translateX(-50%) translateY(0) scale(1); } }
        .stage-number-badge { position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); width: 44px; height: 44px; background: #4DB6F7; border: 3px solid #2C88C7; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; color: white; box-shadow: 0 0 0 1px #5AC8F7, 3px 3px 0 0 rgba(0,0,0,0.3); z-index: 5; padding: 2px; }
        .stage-number-badge::before { content: ''; width: 6px; height: 6px; background: white; border-radius: 50%; position: absolute; top: 8px; left: 10px; box-shadow: 0 0 0 1px #2C88C7; }
        .stage-number-badge::after { content: ''; width: 6px; height: 6px; background: white; border-radius: 50%; position: absolute; top: 8px; right: 10px; box-shadow: 0 0 0 1px #2C88C7; }
        .stage-number-text { margin-top: 14px; }
        .stage-node.locked .stage-number-badge { background: #757575; border-color: #616161; box-shadow: 0 0 0 1px #9E9E9E, 3px 3px 0 0 rgba(0,0,0,0.3); }
        .stage-node.locked .stage-number-badge::before, .stage-node.locked .stage-number-badge::after { background: #ccc; box-shadow: 0 0 0 1px #616161; }
        .stage-node.completed .stage-number-badge { background: #8EE38F; border-color: #6CBD6C; }
        .stage-node.completed .stage-number-badge::before, .stage-node.completed .stage-number-badge::after { box-shadow: 0 0 0 1px #6CBD6C; }
        .hero-face { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); width: 40px; height: 40px; background-color: #FFEB3B; border: 3px solid #FBC02D; border-radius: 50%; z-index: 20; display: none; box-shadow: 2px 2px 0 rgba(0,0,0,0.2); animation: hero-face-bounce 1.5s ease-in-out infinite; }
        .hero-face::before, .hero-face::after { content: ''; position: absolute; width: 6px; height: 8px; background-color: #333; border-radius: 3px / 4px; top: 12px; }
        .hero-face::before { left: 9px; }
        .hero-face::after { right: 9px; }
        .hero-face .mouth { position: absolute; width: 16px; height: 2px; background-color: #333; bottom: 10px; left: 50%; transform: translateX(-50%); border-radius: 1px; }
        .stage-node.current .hero-face { display: block; }
        @keyframes hero-face-bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-4px); } }
        .stage-info { background: white; border: 3px solid #333; padding: 12px 16px; margin-top: 16px; position: relative; box-shadow: 0 0 0 1px #666, 4px 4px 0 0 rgba(0,0,0,0.2); }
        .stage-title { font-size: 1.1rem; font-weight: bold; color: #333; margin-bottom: 4px; }
        .stage-description { font-size: 0.9rem; color: #666; line-height: 1.4; }
        .path-line { position: absolute; width: 60px; height: 4px; background: repeating-linear-gradient( 90deg, #8B4513, #8B4513 10px, #D2691E 10px, #D2691E 20px ); top: 60px; right: -60px; transform: translateY(-50%); z-index: 1; }
        .stage-node:nth-child(3n) .path-line, .stage-node:last-child .path-line { display: none; }
        @media (max-width: 767px) { .stage-node:nth-child(3n) .path-line { display: block; } .stage-node:nth-child(2n) .path-line, .stage-node:last-child .path-line { display: none; } }
        .quest-button { position: fixed; bottom: 30px; right: 30px; width: auto; min-width: 200px; margin: 0; padding: 16px 32px; background: #FF6B6B; border: 4px solid #DC143C; color: white; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 0 0 2px #FF8787, 6px 6px 0 0 rgba(0,0,0,0.3); transition: all 0.1s ease; animation: pulse_button 2s ease-in-out infinite; z-index: 900; }
        @keyframes pulse_button { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .quest-button:hover { transform: translate(-2px, -2px) scale(1.02); box-shadow: 0 0 0 2px #FF8787, 8px 8px 0 0 rgba(0,0,0,0.3); animation: none; }
        .quest-button:active { transform: translate(2px, 2px); box-shadow: 0 0 0 2px #FF8787, 2px 2px 0 0 rgba(0,0,0,0.3); }
        @media (max-width: 767px) { .quest-button { padding: 12px 24px; font-size: 1rem; bottom: 20px; right: 20px; min-width: 160px; } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1001; align-items: center; justify-content: center; }
        .modal-content { background: #F5F5DC; border: 4px solid #8B4513; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 0 0 2px #A0522D, 8px 8px 0 0 rgba(0,0,0,0.5); position: relative; }
        .modal-close { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; background: #DC143C; border: 2px solid #8B0000; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; font-weight: bold; box-shadow: 2px 2px 0 0 rgba(0,0,0,0.5); }
        .modal-close:hover { transform: translate(-1px, -1px); box-shadow: 3px 3px 0 0 rgba(0,0,0,0.5); }
        .modal-close:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0 0 rgba(0,0,0,0.5); }
        .modal-title { font-size: 1.6rem; color: #8B4513; margin-bottom: 16px; font-weight: bold; text-align: center; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
        .modal-description { color: #654321; margin-bottom: 20px; line-height: 1.6; text-align: center; }
        .modal-message { background: #FFF9C4; border: 2px solid #F9A825; padding: 16px; margin-bottom: 24px; text-align: center; font-style: italic; color: #5D4037; box-shadow: inset 0 0 8px rgba(0,0,0,0.1); }
        .modal-buttons { display: flex; gap: 16px; justify-content: center; }
        @media (max-width: 767px) { .modal-buttons { flex-direction: column; } }
        .modal-button { flex: 1; padding: 12px 24px; border: 3px solid; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.1s ease; position: relative; }
        .modal-button.video { background: #4CAF50; border-color: #388E3C; color: white; box-shadow: 0 0 0 1px #66BB6A, 4px 4px 0 0 rgba(0,0,0,0.3); }
        .modal-button.video:hover { transform: translate(-2px, -2px); box-shadow: 0 0 0 1px #66BB6A, 6px 6px 0 0 rgba(0,0,0,0.3); }
        .modal-button.quest { background: #2196F3; border-color: #1976D2; color: white; box-shadow: 0 0 0 1px #42A5F5, 4px 4px 0 0 rgba(0,0,0,0.3); }
        .modal-button.quest:hover { transform: translate(-2px, -2px); box-shadow: 0 0 0 1px #42A5F5, 6px 6px 0 0 rgba(0,0,0,0.3); }
        .modal-button:active { transform: translate(1px, 1px); box-shadow: 0 0 0 1px currentColor, 2px 2px 0 0 rgba(0,0,0,0.3); }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .loading-content { text-align: center; background: #F5F5DC; padding: 30px; border: 4px solid #8B4513; box-shadow: 0 0 0 2px #A0522D, 8px 8px 0 0 rgba(0,0,0,0.5); }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #4DB6F7; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        .loading-content p { color: #654321; font-weight: bold; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Ë™çË®ºÈñ¢ÈÄ£„Çπ„Çø„Ç§„É´ */
        .auth-status { 
            position: fixed; 
            top: 80px; 
            right: 20px; 
            background: rgba(255, 255, 255, 0.95); 
            border: 3px solid #333; 
            padding: 12px 16px; 
            border-radius: 8px; 
            box-shadow: 0 0 0 1px #666, 4px 4px 0 0 rgba(0,0,0,0.3); 
            z-index: 999; 
            min-width: 200px; 
        }
        .auth-loading { color: #666; font-size: 0.9rem; }
        .auth-user-info { display: none; }
        .auth-user-info.show { display: block; }
        .auth-user-name { font-weight: bold; color: #333; margin-bottom: 4px; }
        .auth-user-email { font-size: 0.8rem; color: #666; margin-bottom: 8px; }
        .auth-logout-btn { 
            background: #DC143C; 
            color: white; 
            border: 2px solid #B91C1C; 
            padding: 6px 12px; 
            font-size: 0.8rem; 
            cursor: pointer; 
            border-radius: 4px; 
            transition: all 0.1s ease; 
        }
        .auth-logout-btn:hover { 
            background: #B91C1C; 
            transform: translate(-1px, -1px); 
            box-shadow: 2px 2px 0 0 rgba(0,0,0,0.3); 
        }
        .auth-login-prompt { display: none; }
        .auth-login-prompt.show { display: block; }
        .auth-login-btn { 
            background: #4CAF50; 
            color: white; 
            border: 2px solid #388E3C; 
            padding: 8px 16px; 
            font-size: 0.9rem; 
            cursor: pointer; 
            border-radius: 4px; 
            transition: all 0.1s ease; 
            margin-top: 8px; 
        }
        .auth-login-btn:hover { 
            background: #388E3C; 
            transform: translate(-1px, -1px); 
            box-shadow: 2px 2px 0 0 rgba(0,0,0,0.3); 
        }
        
        .auth-modal-content { max-width: 450px; }
        .auth-tabs { 
            display: flex; 
            margin-bottom: 20px; 
            border-bottom: 3px solid #333; 
        }
        .auth-tab { 
            flex: 1; 
            padding: 12px; 
            background: #E0E0E0; 
            border: none; 
            border-bottom: 3px solid transparent; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.2s ease; 
        }
        .auth-tab.active { 
            background: #FFF; 
            border-bottom-color: #4CAF50; 
            color: #4CAF50; 
        }
        .auth-tab:hover:not(.active) { background: #F0F0F0; }
        
        .auth-form h3 { 
            color: #333; 
            margin-bottom: 20px; 
            text-align: center; 
        }
        .form-group { margin-bottom: 16px; }
        .form-group label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: bold; 
            color: #333; 
        }
        .form-group input { 
            width: 100%; 
            padding: 12px; 
            border: 3px solid #DDD; 
            border-radius: 4px; 
            font-size: 1rem; 
            transition: border-color 0.2s ease; 
        }
        .form-group input:focus { 
            outline: none; 
            border-color: #4CAF50; 
        }
        .auth-submit-btn { 
            width: 100%; 
            padding: 14px; 
            background: #4CAF50; 
            color: white; 
            border: 3px solid #388E3C; 
            font-size: 1.1rem; 
            font-weight: bold; 
            cursor: pointer; 
            border-radius: 4px; 
            transition: all 0.1s ease; 
            margin-bottom: 12px; 
        }
        .auth-submit-btn:hover { 
            background: #388E3C; 
            transform: translate(-2px, -2px); 
            box-shadow: 4px 4px 0 0 rgba(0,0,0,0.3); 
        }
        .auth-submit-btn:active { 
            transform: translate(1px, 1px); 
            box-shadow: 1px 1px 0 0 rgba(0,0,0,0.3); 
        }
        .auth-submit-btn:disabled { 
            background: #CCC; 
            border-color: #999; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }
        
        .auth-message { 
            padding: 12px; 
            border-radius: 4px; 
            text-align: center; 
            font-weight: bold; 
            margin-top: 12px; 
            display: none; 
        }
        .auth-message.success { 
            background: #E8F5E9; 
            border: 2px solid #4CAF50; 
            color: #2E7D32; 
            display: block; 
        }
        .auth-message.error { 
            background: #FFEBEE; 
            border: 2px solid #F44336; 
            color: #C62828; 
            display: block; 
        }
        
        @media (max-width: 767px) { 
            .auth-status { 
                position: relative; 
                top: 0; 
                right: 0; 
                margin-bottom: 20px; 
                width: 100%; 
            } 
        }
    </style>
</head>
<body>
    <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ÔºàÂÖ±ÈÄöÔºâ -->
    <div data-include="partials/navigation.html"></div>
    
    <div id="skyObjectsContainer"></div>
    <div class="loading-overlay" id="loadingOverlay"> <div class="loading-content"> <div class="loading-spinner"></div> <p>ÂÜíÈô∫„ÅÆÊ∫ñÂÇô‰∏≠...</p> </div> </div>
    
    <div class="container">
        <!-- Ë™çË®ºÁä∂ÊÖãË°®Á§∫ -->
        <div class="auth-status" id="authStatus">
            <div class="auth-loading">Ë™çË®ºÁä∂ÊÖã„ÇíÁ¢∫Ë™ç‰∏≠...</div>
        </div>
        
        <header class="map-header"> <h1>üó∫Ô∏è CLAFT „ÇØ„Ç®„Çπ„Éà„Éû„ÉÉ„Éó</h1> <p>„Åç„Åø„Å†„Åë„ÅÆÂÜíÈô∫Áâ©Ë™û„Çí„Å§„Åè„Çç„ÅÜÔºÅ</p> <button class="adventure-log-button" id="adventureLogBtn"> „Åì„Çå„Åæ„Åß„ÅÆÂÜíÈô∫„ÇíÊåØ„ÇäËøî„Çã </button> </header>
        <div class="stage-grid" id="stageGrid">
            <!-- „Çπ„ÉÜ„Éº„Ç∏1 -->
            <div class="stage-node" id="stage-1" data-stage-id="1">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-face"><div class="mouth"></div></div> 
                <div class="stage-icon">
                    <img class="icon-image" src="" alt="„Çπ„ÉÜ„Éº„Ç∏1„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üè†</span>
                    <img class="clear-effect" src="" alt="ÁÖô„Ç®„Éï„Çß„ÇØ„Éà" data-effect-type="smoke">
                </div>
                <div class="stage-number-badge"><span class="stage-number-text">1</span></div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
                <div class="path-line"></div>
            </div>
            <!-- „Çπ„ÉÜ„Éº„Ç∏2 -->
            <div class="stage-node" id="stage-2" data-stage-id="2">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-face"><div class="mouth"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="" alt="„Çπ„ÉÜ„Éº„Ç∏2„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üå≤</span>
                    <img class="clear-effect" src="" alt="ÂãïÁâ©„Ç®„Éï„Çß„ÇØ„Éà" data-effect-type="animal">
                </div>
                <div class="stage-number-badge"><span class="stage-number-text">2</span></div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
                <div class="path-line"></div>
            </div>
            <!-- „Çπ„ÉÜ„Éº„Ç∏3 -->
            <div class="stage-node" id="stage-3" data-stage-id="3">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-face"><div class="mouth"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="" alt="„Çπ„ÉÜ„Éº„Ç∏3„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">‚öîÔ∏è</span>
                </div>
                <div class="stage-number-badge"><span class="stage-number-text">3</span></div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
                <div class="path-line"></div>
            </div>
            <!-- „Çπ„ÉÜ„Éº„Ç∏4 -->
            <div class="stage-node" id="stage-4" data-stage-id="4">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-face"><div class="mouth"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="" alt="„Çπ„ÉÜ„Éº„Ç∏4„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üõ°Ô∏è</span>
                </div>
                <div class="stage-number-badge"><span class="stage-number-text">4</span></div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
                <div class="path-line"></div>
            </div>
            <!-- „Çπ„ÉÜ„Éº„Ç∏5 -->
            <div class="stage-node" id="stage-5" data-stage-id="5">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-face"><div class="mouth"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="" alt="„Çπ„ÉÜ„Éº„Ç∏5„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üë•</span>
                </div>
                <div class="stage-number-badge"><span class="stage-number-text">5</span></div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
                <div class="path-line"></div>
            </div>
            <!-- „Çπ„ÉÜ„Éº„Ç∏6 -->
            <div class="stage-node" id="stage-6" data-stage-id="6">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-face"><div class="mouth"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="" alt="„Çπ„ÉÜ„Éº„Ç∏6„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üè∞</span>
                </div>
                <div class="stage-number-badge"><span class="stage-number-text">6</span></div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
            </div>
        </div>
    </div>
    <button class="quest-button" id="mainQuestButton">üî• Ê¨°„ÅÆÂÜíÈô∫„Å∏ÈÄ≤„ÇÄÔºÅ</button>
    <div class="modal" id="stageModal"> <div class="modal-content"> <button class="modal-close" id="modalCloseBtn">√ó</button> <h2 class="modal-title" id="modalStageTitle"></h2> <p class="modal-description" id="modalStageDescription"></p> <div class="modal-message" id="modalStageMessage"></div> <div class="modal-buttons"> <button class="modal-button video" id="modalVideoBtn">üé¨ ÂãïÁîª„ÇíË¶ã„Çã</button> <button class="modal-button quest" id="modalQuestBtn">‚öîÔ∏è „ÇØ„Ç®„Çπ„Éà„Å´Êåë„ÇÄ</button> </div> </div> </div>
    
    <!-- Ë™çË®º„É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="authModal">
        <div class="modal-content auth-modal-content">
            <button class="modal-close" id="authModalCloseBtn">√ó</button>
            <h2 class="modal-title" id="authModalTitle">üîê ÂÜíÈô∫ËÄÖÁôªÈå≤„Éª„É≠„Ç∞„Ç§„É≥</h2>
            
            <!-- „Çø„ÉñÂàá„ÇäÊõø„Åà -->
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">„É≠„Ç∞„Ç§„É≥</button>
                <button class="auth-tab" data-tab="signup">Êñ∞Ë¶èÁôªÈå≤</button>
            </div>
            
            <!-- „É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É† -->
            <div class="auth-form" id="loginForm">
                <h3>ÂÜíÈô∫ËÄÖ„Å®„Åó„Å¶„É≠„Ç∞„Ç§„É≥</h3>
                <div class="form-group">
                    <label for="loginEmail">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" id="loginEmail" placeholder="your-email@example.com" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                    <input type="password" id="loginPassword" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ" required>
                </div>
                <button class="auth-submit-btn" id="loginSubmitBtn">üö™ „É≠„Ç∞„Ç§„É≥</button>
                <div class="auth-message" id="loginMessage"></div>
            </div>
            
            <!-- „Çµ„Ç§„É≥„Ç¢„ÉÉ„Éó„Éï„Ç©„Éº„É† -->
            <div class="auth-form" id="signupForm" style="display: none;">
                <h3>Êñ∞„Åó„ÅÑÂÜíÈô∫ËÄÖ„Å®„Åó„Å¶ÁôªÈå≤</h3>
                <div class="form-group">
                    <label for="signupEmail">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" id="signupEmail" placeholder="your-email@example.com" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                    <input type="password" id="signupPassword" placeholder="6ÊñáÂ≠ó‰ª•‰∏ä„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ" required>
                </div>
                <div class="form-group">
                    <label for="signupDisplayName">ÂÜíÈô∫ËÄÖÂêçÔºà‰ªªÊÑèÔºâ</label>
                    <input type="text" id="signupDisplayName" placeholder="„ÅÇ„Å™„Åü„ÅÆÂÜíÈô∫ËÄÖÂêç">
                </div>
                <button class="auth-submit-btn" id="signupSubmitBtn">‚öîÔ∏è ÂÜíÈô∫ËÄÖÁôªÈå≤</button>
                <div class="auth-message" id="signupMessage"></div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
    <script>
        // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„ÉàË®≠ÂÆö
        const supabaseUrl = 'https://laqvpxecqvlufboquffe.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhcXZweGVjcXZsdWZib3F1ZmZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MzYwNjgsImV4cCI6MjA2NDAxMjA2OH0.IRkg1miEpOGIFQMnno_P0hsMe1IgwCi2kl_kNcrmZTw';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        // Ë™çË®ºÊ©üËÉΩ
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.init();
            }

            async init() {
                // Ë™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
                supabase.auth.onAuthStateChange((event, session) => {
                    console.log('Ë™çË®ºÁä∂ÊÖãÂ§âÊõ¥:', event, session);
                    this.handleAuthStateChange(session);
                });

                // ÂàùÊúüË™çË®ºÁä∂ÊÖã„ÅÆÁ¢∫Ë™ç
                const { data: { session } } = await supabase.auth.getSession();
                this.handleAuthStateChange(session);
            }

            handleAuthStateChange(session) {
                this.currentUser = session?.user || null;
                this.updateAuthUI();
                // Ë™çË®ºÁä∂ÊÖã„ÅåÂ§â„Çè„Å£„Åü„Çâ„ÇØ„Ç®„Çπ„Éà„Éû„ÉÉ„Éó„ÇÇÊõ¥Êñ∞
                initializeAppLogic();
            }

            updateAuthUI() {
                const authStatus = document.getElementById('authStatus');
                
                if (this.currentUser) {
                    // „É≠„Ç∞„Ç§„É≥Ê∏à„Åø
                    const displayName = this.currentUser.user_metadata?.display_name || ' ÂÜíÈô∫ËÄÖ';
                    authStatus.innerHTML = `
                        <div class="auth-user-info show">
                            <div class="auth-user-name">üéÆ ${displayName}</div>
                            <div class="auth-user-email">${this.currentUser.email}</div>
                            <button class="auth-logout-btn" onclick="authManager.logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                        </div>
                    `;
                } else {
                    // Êú™„É≠„Ç∞„Ç§„É≥
                    authStatus.innerHTML = `
                        <div class="auth-login-prompt show">
                            <div>ÂÜíÈô∫ËÄÖÁôªÈå≤„ÅßÈÄ≤Ë°åÁä∂Ê≥Å„Çí‰øùÂ≠òÔºÅ</div>
                            <button class="auth-login-btn" onclick="authManager.showAuthModal()">„É≠„Ç∞„Ç§„É≥ / ÁôªÈå≤</button>
                        </div>
                    `;
                }
            }

            showAuthModal() {
                const modal = document.getElementById('authModal');
                modal.style.display = 'flex';
                this.setupAuthModal();
            }

            hideAuthModal() {
                const modal = document.getElementById('authModal');
                modal.style.display = 'none';
                this.clearAuthForms();
            }

            setupAuthModal() {
                // „Çø„ÉñÂàá„ÇäÊõø„Åà
                const tabs = document.querySelectorAll('.auth-tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const targetTab = tab.dataset.tab;
                        this.switchAuthTab(targetTab);
                    });
                });

                // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°
                document.getElementById('loginSubmitBtn').onclick = () => this.handleLogin();
                document.getElementById('signupSubmitBtn').onclick = () => this.handleSignup();

                // „É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã
                document.getElementById('authModalCloseBtn').onclick = () => this.hideAuthModal();
            }

            switchAuthTab(tabName) {
                // „Çø„Éñ„ÅÆÂàá„ÇäÊõø„Åà
                document.querySelectorAll('.auth-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // „Éï„Ç©„Éº„É†„ÅÆÂàá„ÇäÊõø„Åà
                document.getElementById('loginForm').style.display = tabName === 'login' ? 'block' : 'none';
                document.getElementById('signupForm').style.display = tabName === 'signup' ? 'block' : 'none';
            }

            async handleLogin() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const messageDiv = document.getElementById('loginMessage');
                const submitBtn = document.getElementById('loginSubmitBtn');

                if (!email || !password) {
                    this.showAuthMessage(messageDiv, '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = '„É≠„Ç∞„Ç§„É≥‰∏≠...';

                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) throw error;

                    this.showAuthMessage(messageDiv, '‚úÖ „É≠„Ç∞„Ç§„É≥ÊàêÂäüÔºÅÂÜíÈô∫„ÇíÁ∂ö„Åë„Åæ„Åó„Çá„ÅÜÔºÅ', 'success');
                    setTimeout(() => {
                        this.hideAuthModal();
                    }, 1500);

                } catch (error) {
                    console.error('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
                    this.showAuthMessage(messageDiv, '‚ùå „É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üö™ „É≠„Ç∞„Ç§„É≥';
                }
            }

            async handleSignup() {
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const displayName = document.getElementById('signupDisplayName').value;
                const messageDiv = document.getElementById('signupMessage');
                const submitBtn = document.getElementById('signupSubmitBtn');

                if (!email || !password) {
                    this.showAuthMessage(messageDiv, '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    return;
                }

                if (password.length < 6) {
                    this.showAuthMessage(messageDiv, '„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'ÁôªÈå≤‰∏≠...';

                try {
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                display_name: displayName || 'ÂÜíÈô∫ËÄÖ'
                            }
                        }
                    });

                    if (error) throw error;

                    this.showAuthMessage(messageDiv, '‚úÖ ÁôªÈå≤ÂÆå‰∫ÜÔºÅ„É°„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÊúâÂäπÂåñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'success');
                    setTimeout(() => {
                        this.switchAuthTab('login');
                    }, 2000);

                } catch (error) {
                    console.error('„Çµ„Ç§„É≥„Ç¢„ÉÉ„Éó„Ç®„É©„Éº:', error);
                    this.showAuthMessage(messageDiv, '‚ùå ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚öîÔ∏è ÂÜíÈô∫ËÄÖÁôªÈå≤';
                }
            }

            async logout() {
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                    
                    // „Éö„Éº„Ç∏„É™„É≠„Éº„Éâ„Åó„Å¶Áä∂ÊÖã„Çí„ÇØ„É™„Ç¢
                    window.location.reload();
                } catch (error) {
                    console.error('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
                    alert('„É≠„Ç∞„Ç¢„Ç¶„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }

            showAuthMessage(messageDiv, text, type) {
                messageDiv.textContent = text;
                messageDiv.className = `auth-message ${type}`;
            }

            clearAuthForms() {
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('signupEmail').value = '';
                document.getElementById('signupPassword').value = '';
                document.getElementById('signupDisplayName').value = '';
                
                document.querySelectorAll('.auth-message').forEach(msg => {
                    msg.className = 'auth-message';
                });
            }
        }

        // Ë™çË®º„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆÂàùÊúüÂåñ
        const authManager = new AuthManager();
    </script>
    <script>
        const TOTAL_STAGES = 6;
        const NUM_SKY_OBJECTS = 7; 

        const stageStaticData = {
            1: { title: 'Âêõ„ÅØ„Å©„Çì„Å™ÂÜíÈô∫ËÄÖÔºü', description: '„Åì„ÅÆ‰∏ñÁïå„ÅÆÂú∞Âõ≥„Çí„Å≤„Çâ„ÅÑ„Å¶„ÄÅCLAFT„ÇíÂÜíÈô∫„Åó„Çà„ÅÜÔºÅ', message: '„Äå„Åì„ÅÆ‰∏ñÁïå„Çí„Å©„ÅÜÊ≠©„Åè„Åã„ÅØ„ÄÅËá™ÂàÜ„ÅßÊ±∫„ÇÅ„Å¶„ÅÑ„ÅÑ„Äç', iconImage: 'https://via.placeholder.com/64x64/8B4513/FFFFFF?text=House', fallbackIcon: 'üè†', clearEffectImage: 'https://via.placeholder.com/32x32/CCCCCC/000000?text=Smoke' },
            2: { title: '„ÉØ„ÇØ„ÇÇ„ÇÑ„Ç®„Éç„É´„ÇÆ„Éº', description: '„ÉØ„ÇØ„ÉØ„ÇØ„Éª„ÇÇ„ÇÑ„ÇÇ„ÇÑ„ÅØÂïè„ÅÑ„ÅÆÂéüÂãïÂäõ„Å´„Å™„Çã', message: '„ÄåÂêõ„ÅÆÊÑü„Åò„Åü"„ÇÇ„ÇÑ„ÇÇ„ÇÑ"„Åå„ÄÅÂÜíÈô∫„ÅÆÂá∫Áô∫ÁÇπ„Äç', iconImage: 'https://via.placeholder.com/64x64/228B22/FFFFFF?text=Forest', fallbackIcon: 'üå≤', clearEffectImage: 'https://via.placeholder.com/32x32/8B4513/FFFFFF?text=Animal' },
            3: { title: 'Âêõ„ÅØ„Å©„Çì„Å™„Ç≠„É£„É©Ôºü', description: 'Ëá™ÂàÜ„ÇíËÇ≤„Å¶„ÇãËÇ≤Êàê„Ç≤„Éº„É†', message: '„ÄåËá™ÂàÜ„ÅÆ„Çπ„Ç≠„É´„ÉÑ„É™„Éº„ÇíËÇ≤„Å¶„Çã„ÅÆ„ÅØ„ÄÅÂêõËá™Ë∫´„Å†„Äç', iconImage: 'https://via.placeholder.com/64x64/4169E1/FFFFFF?text=Sword', fallbackIcon: '‚öîÔ∏è', clearEffectImage: null },
            4: { title: '„Å©„Çì„Å™ÈÅìÂÖ∑„ÇíÊåÅ„Å£„Å¶„ÇãÔºü', description: '„Åì„ÅÆ‰∏ñÁïå„ÅÆÂú∞Âõ≥„Çí„Å≤„Çâ„ÅÑ„Å¶„ÄÅCLAFT„ÇíÂÜíÈô∫„Åó„Çà„ÅÜÔºÅ', message: '„ÄåËá™ÂàÜ„ÅÆ„Çπ„Ç≠„É´„ÉÑ„É™„Éº„ÇíËÇ≤„Å¶„Çã„ÅÆ„ÅØ„ÄÅÂêõËá™Ë∫´„Å†„Äç', iconImage: 'https://via.placeholder.com/64x64/FFD700/000000?text=Shield', fallbackIcon: 'üõ°Ô∏è', clearEffectImage: null },
            5: { title: '‰ª≤Èñì„Å®ÂÜíÈô∫„Åô„Çã„Å£„Å¶Ôºü', description: '„Åì„ÅÆ‰∏ñÁïå„ÅÆÂú∞Âõ≥„Çí„Å≤„Çâ„ÅÑ„Å¶„ÄÅCLAFT„ÇíÂÜíÈô∫„Åó„Çà„ÅÜÔºÅ', message: '„ÄåËá™ÂàÜ„ÅÆ„Çπ„Ç≠„É´„ÉÑ„É™„Éº„ÇíËÇ≤„Å¶„Çã„ÅÆ„ÅØ„ÄÅÂêõËá™Ë∫´„Å†„Äç', iconImage: 'https://via.placeholder.com/64x64/32CD32/FFFFFF?text=Team', fallbackIcon: 'üë•', clearEffectImage: null },
            6: { title: 'Êú™Êù•„ÅÆ„Éú„Çπ„Å®Âêë„ÅçÂêà„ÅÜ', description: '„Åì„ÅÆ‰∏ñÁïå„ÅÆÂú∞Âõ≥„Çí„Å≤„Çâ„ÅÑ„Å¶„ÄÅCLAFT„ÇíÂÜíÈô∫„Åó„Çà„ÅÜÔºÅ', message: '„ÄåËá™ÂàÜ„ÅÆ„Çπ„Ç≠„É´„ÉÑ„É™„Éº„ÇíËÇ≤„Å¶„Çã„ÅÆ„ÅØ„ÄÅÂêõËá™Ë∫´„Å†„Äç', iconImage: 'https://via.placeholder.com/64x64/8B0000/FFFFFF?text=Boss', fallbackIcon: 'üè∞', clearEffectImage: null }
        };
        
        const loadingOverlay = document.getElementById('loadingOverlay');
        const stageGrid = document.getElementById('stageGrid');
        const mainQuestButton = document.getElementById('mainQuestButton');
        const stageModal = document.getElementById('stageModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalStageTitle = document.getElementById('modalStageTitle');
        const modalStageDescription = document.getElementById('modalStageDescription');
        const modalStageMessage = document.getElementById('modalStageMessage');
        const modalVideoBtn = document.getElementById('modalVideoBtn');
        const modalQuestBtn = document.getElementById('modalQuestBtn');
        const skyObjectsContainer = document.getElementById('skyObjectsContainer');
        
        function createSkyObjects() {
            skyObjectsContainer.innerHTML = ''; 
            for (let i = 0; i < NUM_SKY_OBJECTS; i++) {
                const obj = document.createElement('div');
                obj.classList.add('sky-object');
                let type;
                const randomValue = Math.random();
                if (randomValue < 0.95) { type = 'cloud'; } else { type = 'ufo'; }
                obj.classList.add(type);
                obj.style.top = `${Math.random() * 70 + 5}%`; 
                const duration = Math.random() * 25 + 20; 
                obj.style.animationDuration = `${duration}s`;
                const startY = Math.random() * 10 - 5; 
                const endY = Math.random() * 10 - 5;
                obj.style.setProperty('--sy', `${startY}px`);
                obj.style.setProperty('--ey', `${endY}px`);
                if (Math.random() < 0.5) { obj.style.left = `-${Math.random() * 100 + 100}px`; obj.style.animationName = 'float-sky-ltr'; } 
                else { obj.style.right = `-${Math.random() * 100 + 100}px`; obj.style.animationName = 'float-sky-rtl'; }
                obj.style.animationDelay = `${Math.random() * duration * 0.8}s`; 
                skyObjectsContainer.appendChild(obj);
            }
        }
        
        // „ÇØ„Ç®„Çπ„Éà„Éû„ÉÉ„Éó„ÅÆÂàùÊúüÂåñ
        let currentUserId = null;
        let userProgress = {}; 
        let currentStageIdForModal = null;
        let currentUser = null; 

        async function initializeAppLogic() { 
            if (authManager.currentUser) {
                currentUserId = authManager.currentUser.id;
                userProgress = await fetchUserProgress(currentUserId);
            } else {
                currentUserId = null;
                for (let i = 1; i <= TOTAL_STAGES; i++) userProgress[i] = 'locked';
            }
            updateStageDisplay(); 
        }
        
        function showLoading(show) { loadingOverlay.style.display = show ? 'flex' : 'none'; }
        function getUserIdFromUrl() { const params = new URLSearchParams(window.location.search); return params.get('userId'); }
        
        async function fetchUserProgress(userId) { 
            showLoading(true); 
            console.log(`Fetching progress for userId: ${userId}`); 
            if (!supabase) { console.error('Supabase client is not initialized for fetching progress.'); showLoading(false); const defaultProgress = {}; for (let i = 1; i <= TOTAL_STAGES; i++) defaultProgress[i] = (i === 1 && userId ? 'current' : 'locked'); return defaultProgress; }
            try { const { data, error } = await supabase.from('claft-quest').select('stage_id, status').eq('user_id', userId); if (error) throw error; const progress = {}; for (let i = 1; i <= TOTAL_STAGES; i++) { const record = data.find(r => r.stage_id === i); progress[i] = record ? record.status : (i === 1 ? 'current' : 'locked'); } if (data.length === 0) { progress[1] = 'current'; for (let i = 2; i <= TOTAL_STAGES; i++) progress[i] = 'locked'; } console.log('Progress fetched from Supabase:', progress); return progress; } catch (error) { console.error('Error fetching user progress from Supabase:', error.message); const defaultProgress = {}; for (let i = 1; i <= TOTAL_STAGES; i++) defaultProgress[i] = (i === 1 && userId ? 'current' : 'locked'); return defaultProgress; } finally { showLoading(false); }
        }
        async function saveUserProgress(userId, stageId, newStatus) { 
            showLoading(true); 
            console.log(`Saving progress for userId: ${userId}, stageId: ${stageId}, status: ${newStatus}`); 
            if (!supabase) { console.error('Supabase client is not initialized for saving progress.'); showLoading(false); return false; }
            try { const { data, error } = await supabase.from('claft-quest').upsert({ user_id: userId, stage_id: stageId, status: newStatus }, { onConflict: 'user_id, stage_id' }).select(); if (error) throw error; console.log('Progress saved to Supabase:', data); userProgress[stageId] = newStatus; return true; } catch (error) { console.error('Error saving user progress to Supabase:', error.message); return false; } finally { showLoading(false); }
        }
        
        function updateStageDisplay() { 
            let currentStageExists = false; let allStagesCompleted = true; 
            for (let i = 1; i <= TOTAL_STAGES; i++) { 
                const stageNode = document.getElementById(`stage-${i}`); if (!stageNode) continue; 
                const status = userProgress[i] || 'locked'; 
                stageNode.classList.remove('completed', 'current', 'locked'); stageNode.classList.add(status); 
                if (status !== 'completed') { allStagesCompleted = false; } 
                const staticInfo = stageStaticData[i]; 
                stageNode.querySelector('.stage-title').textContent = staticInfo.title; 
                stageNode.querySelector('.stage-description').textContent = staticInfo.description; 
                const iconImg = stageNode.querySelector('.stage-icon img.icon-image'); 
                const fallbackSpan = stageNode.querySelector('.stage-icon .icon-fallback'); 
                if (iconImg) { iconImg.src = staticInfo.iconImage; iconImg.style.display = 'block'; fallbackSpan.style.display = 'none'; fallbackSpan.textContent = staticInfo.fallbackIcon; } 
                const clearEffectImg = stageNode.querySelector('.clear-effect'); 
                if (clearEffectImg) { if (status === 'completed' && staticInfo.clearEffectImage) { clearEffectImg.src = staticInfo.clearEffectImage; clearEffectImg.style.display = 'block'; } else { clearEffectImg.style.display = 'none'; } } 
                const heroFace = stageNode.querySelector('.hero-face'); 
                if (heroFace) { if (status === 'current') { heroFace.style.display = 'block'; currentStageExists = true; } else { heroFace.style.display = 'none'; } } 
            } 
            if (allStagesCompleted && Object.keys(userProgress).length >= TOTAL_STAGES ) { mainQuestButton.textContent = 'üéâ ÂÖ®„Å¶„ÅÆÂÜíÈô∫„ÇíÈÅîÊàêÔºÅ'; mainQuestButton.disabled = true; }  // userProgress„Åå„É≠„Éº„Éâ„Åï„Çå„Å¶„Åã„ÇâÂÖ®„ÇØ„É™„Ç¢Âà§ÂÆö
            else if (!currentStageExists && !allStagesCompleted && Object.keys(userProgress).length > 0) { 
                mainQuestButton.textContent = '‚ùì Ê¨°„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Å∏'; 
                mainQuestButton.disabled = false; 
                 const firstLocked = Object.entries(userProgress).find(([id, stat]) => stat === 'locked');
                 if (firstLocked) { console.warn(`No current stage found, attempting to set stage ${firstLocked[0]} as current.`); } 
                 else { mainQuestButton.textContent = 'üöÄ Êñ∞„Åü„Å™ÂÜíÈô∫Ôºü'; }
            } else if (!currentStageExists && allStagesCompleted && Object.keys(userProgress).length === 0 ) { // ÂàùÊúüÁä∂ÊÖã„Å™„Å©
                 mainQuestButton.textContent = 'üöÄ ÂÜíÈô∫„ÇíÂßã„ÇÅ„Çà„ÅÜÔºÅ'; mainQuestButton.disabled = false;
            }
            else { mainQuestButton.textContent = 'üî• Ê¨°„ÅÆÂÜíÈô∫„Å∏ÈÄ≤„ÇÄÔºÅ'; mainQuestButton.disabled = false; }
        }

        function openStageModal(stageId) { const status = userProgress[stageId]; if (status === 'locked') { alert('„Åì„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÅØ„Åæ„Å†ÈñãÊîæ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºÅ'); return; } currentStageIdForModal = stageId; const staticInfo = stageStaticData[stageId]; modalStageTitle.textContent = `„Çπ„ÉÜ„Éº„Ç∏ ${stageId}: ${staticInfo.title}`; modalStageDescription.textContent = staticInfo.description; modalStageMessage.textContent = staticInfo.message; modalQuestBtn.style.display = (status === 'current') ? 'block' : 'none'; stageModal.style.display = 'flex'; }
        function closeStageModal() { stageModal.style.display = 'none'; currentStageIdForModal = null; }
        

        document.querySelectorAll('.stage-node').forEach(node => { node.addEventListener('click', () => { const stageId = node.dataset.stageId; openStageModal(parseInt(stageId)); }); });
        modalCloseBtn.addEventListener('click', closeStageModal);
        stageModal.addEventListener('click', (e) => { if (e.target === stageModal) closeStageModal(); });
        modalVideoBtn.addEventListener('click', () => { alert(`„Çπ„ÉÜ„Éº„Ç∏ ${currentStageIdForModal} „ÅÆÂãïÁîª„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇÔºàÂÆüË£Ö„ÅØÂà•ÈÄîÔºâ`); });
        modalQuestBtn.addEventListener('click', async () => { if (!currentStageIdForModal || userProgress[currentStageIdForModal] !== 'current') return; const success = await saveUserProgress(currentUserId, currentStageIdForModal, 'completed'); if (success) { userProgress[currentStageIdForModal] = 'completed'; const nextStageId = currentStageIdForModal + 1; if (nextStageId <= TOTAL_STAGES) { const nextSuccess = await saveUserProgress(currentUserId, nextStageId, 'current'); if (nextSuccess) { userProgress[nextStageId] = 'current'; } else { alert('Ê¨°„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÅÆËß£Êîæ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'); } } updateStageDisplay(); closeStageModal(); setTimeout(() => { alert(`„Çπ„ÉÜ„Éº„Ç∏ ${currentStageIdForModal} „ÇØ„É™„Ç¢ÔºÅüéâ ${nextStageId <= TOTAL_STAGES && userProgress[nextStageId] === 'current' ? 'Ê¨°„ÅÆÂÜíÈô∫„Å∏ÈÄ≤„ÇÇ„ÅÜÔºÅ' : 'ÂÖ®„Å¶„ÅÆÂÜíÈô∫„ÇíÈÅîÊàê„Åó„Åæ„Åó„ÅüÔºÅ'}`); }, 100); } else { alert('ÈÄ≤Êçó„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'); } });
        mainQuestButton.addEventListener('click', () => { const currentStageEntry = Object.entries(userProgress).find(([_, status]) => status === 'current'); if (currentStageEntry) { openStageModal(parseInt(currentStageEntry[0])); } else if (Object.values(userProgress).every(s => s === 'completed') && Object.keys(userProgress).length >= TOTAL_STAGES) {} else { const firstNonCompletedOrLocked = Object.entries(userProgress).find(([id, stat]) => stat === 'locked' || stat === 'current'); if (firstNonCompletedOrLocked) { openStageModal(parseInt(firstNonCompletedOrLocked[0])); } else if (Object.keys(userProgress).length === 0) { openStageModal(1); /* ÂàùÊúüÁä∂ÊÖã„Åß„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„ÉÜ„Éº„Ç∏1„ÇíÈñã„ÅèË©¶„Åø */ } else { alert('ÂÜíÈô∫„ÇíÂßã„ÇÅ„ÇãÊ∫ñÂÇô„Åå„Åß„Åç„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');} } });
        document.getElementById('adventureLogBtn').addEventListener('click', () => { let logText = "üìñ „Åì„Çå„Åæ„Åß„ÅÆÂÜíÈô∫„ÅÆË®òÈå≤\n\n"; let completedCount = 0; for (let i = 1; i <= TOTAL_STAGES; i++) { if (userProgress[i] === 'completed') { logText += `„Çπ„ÉÜ„Éº„Ç∏${i}: ${stageStaticData[i].title} - „ÇØ„É™„Ç¢Ê∏à„Åø\n`; completedCount++; } else if (userProgress[i] === 'current') { logText += `„Çπ„ÉÜ„Éº„Ç∏${i}: ${stageStaticData[i].title} - ÊåëÊà¶‰∏≠\n`; } } if (completedCount === 0 && !Object.values(userProgress).some(s => s === 'current')) { logText += '„Åæ„Å†ÂÜíÈô∫„ÅØÂßã„Åæ„Å£„Åü„Å∞„Åã„Çä„Åß„ÅôÔºÅ'; } alert(logText); });

        async function initializeApp() { 
            createSkyObjects(); 
            // Ë™çË®º„Éû„Éç„Éº„Ç∏„É£„Éº„ÅåÂàùÊúüÂåñÂá¶ÁêÜ„ÇíË°å„ÅÜ„ÅÆ„Åß„ÄÅ„Åì„Åì„Åß„ÅØËøΩÂä†„ÅÆÂàùÊúüÂåñ„ÅÆ„Åø
            await initializeAppLogic(); 
        }
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => { console.log('SW registered: ', registration.scope); })
                    .catch(registrationError => { console.log('SW registration failed: ', registrationError); });
            });
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
    
    <!-- „Éë„Éº„Ç∑„É£„É´„Ç§„É≥„ÇØ„É´„Éº„ÉâÊ©üËÉΩ -->
    <script src="js/include.js"></script>
</body>
</html>