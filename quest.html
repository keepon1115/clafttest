<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="screen-orientation" content="landscape">
    <meta name="orientation" content="landscape">
    
    <!-- „Ç≠„É£„ÉÉ„Ç∑„É•Âà∂Âæ° -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- PWAÈñ¢ÈÄ£„É°„Çø„Çø„Ç∞ -->
    <meta name="theme-color" content="#29B6F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CLAFT">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
    <link rel="shortcut icon" href="icons/icon-192.png">
    <!-- manifest.json„ÅØÂãïÁöÑ„Å´Ë™≠„ÅøËæº„ÇÄ -->
    <title>CLAFT „ÇØ„Ç®„Çπ„Éà„Éû„ÉÉ„Éó - ÂÜíÈô∫„ÅÆÊõ∏</title>
    
    <!-- „Éï„Ç©„É≥„Éà„Å®„Çπ„Çø„Ç§„É´ -->
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/navigation.css?v=20250619">
    <link rel="stylesheet" href="css/auth.css?v=20250619">
    <link rel="stylesheet" href="css/quest.css?v=20250619">
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    
    <style>
        /* CSS„ÅØÂâçÂõû„Å®Â§âÊõ¥„Å™„Åó„ÅÆ„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØÁúÅÁï•„Åó„Åæ„Åô */
        /* (ÂÆüÈöõ„ÅÆ„Éï„Ç°„Ç§„É´„Åß„ÅØ„ÄÅÂâçÂõû„ÅÆCSS„Åå„Åì„Åì„Å´„Åù„ÅÆ„Åæ„ÅæÂÖ•„Çä„Åæ„Åô) */
        * { margin: 0; padding: 0; box-sizing: border-box; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; }
        body { font-family: 'DotGothic16', 'M PLUS Rounded 1c', sans-serif; line-height: 1.6; color: #2c2c2c; overflow-x: hidden; background: linear-gradient(to bottom, #87CEEB 0%, #98D8E8 50%, #B0E0E6 100%); min-height: 100vh; position: relative; padding-bottom: 100px; }
        .sky-object { position: fixed; opacity: 0.8; animation-timing-function: linear; animation-iteration-count: infinite; z-index: 1; pointer-events: none; }
        .cloud { width: 100px; height: 40px; background: white; border-radius: 100px; box-shadow: 20px 10px 0 10px white, -20px 10px 0 5px white; }
        .ufo { font-size: 40px; text-align: center; animation: ufo-wobble 3s ease-in-out infinite alternate; }
        .ufo::before { content: 'üõ∏'; }
        @keyframes ufo-wobble { from { transform: translateY(-3px) rotate(-2deg); } to { transform: translateY(3px) rotate(2deg); } }
        @keyframes float-sky-ltr { from { transform: translateX(0) translateY(var(--sy, 0)); } to { transform: translateX(calc(100vw + 200px)) translateY(var(--ey, 0)); } }
        @keyframes float-sky-rtl { from { transform: translateX(0) translateY(var(--sy, 0)); } to { transform: translateX(calc(-100vw - 200px)) translateY(var(--ey, 0)); } }

        .container { max-width: 1200px; margin: 0 auto; padding: 80px 16px 40px; position: relative; z-index: 10; }
        .map-header { text-align: center; margin-bottom: 30px; position: relative; }
        .map-header h1 { font-size: 2.5rem; color: #FFF; margin-bottom: 16px; text-shadow: 2px 2px 0 #4DB6F7, 4px 4px 0 #3A8BC4, 6px 6px 8px rgba(0,0,0,0.3); letter-spacing: 2px; animation: float_title 3s ease-in-out infinite; }
        @keyframes float_title { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .map-header p { font-size: 1.1rem; color: #FFF; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); background: rgba(0,0,0,0.2); display: inline-block; padding: 4px 16px; border-radius: 0; border: 2px solid rgba(255,255,255,0.3); }
        .adventure-log-button { display: inline-block; margin: 20px auto 0; padding: 12px 32px; background: #FFD700; border: 3px solid #B8860B; color: #654321; font-weight: bold; font-size: 1rem; cursor: pointer; position: relative; box-shadow: 0 0 0 1px #DAA520, 4px 4px 0 0 rgba(0,0,0,0.3); transition: all 0.1s ease; }
        .adventure-log-button::before { content: 'üìñ'; margin-right: 8px; }
        .adventure-log-button:hover { transform: translate(-2px, -2px); box-shadow: 0 0 0 1px #DAA520, 6px 6px 0 0 rgba(0,0,0,0.3); }
        .adventure-log-button:active { transform: translate(1px, 1px); box-shadow: 0 0 0 1px #DAA520, 2px 2px 0 0 rgba(0,0,0,0.3); }
        .stage-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 32px; margin-bottom: 40px; padding: 0 20px; }
        @media (max-width: 767px) { .stage-grid { grid-template-columns: repeat(2, 1fr); gap: 24px; padding: 0; } }
        .stage-node { position: relative; text-align: center; cursor: pointer; transition: transform 0.2s ease; }
        .stage-node:nth-child(2), .stage-node:nth-child(5) { transform: translateY(40px); }
        @media (max-width: 767px) { .stage-node:nth-child(even) { transform: translateY(40px); } .stage-node:nth-child(5) { transform: translateY(0); } }
        .stage-node:hover { transform: translateY(-5px) scale(1.05); }
        .stage-node:nth-child(2):hover, .stage-node:nth-child(5):hover { transform: translateY(35px) scale(1.05); }
        @media (max-width: 767px) { .stage-node:nth-child(even):hover { transform: translateY(35px) scale(1.05); } .stage-node:nth-child(5):hover { transform: translateY(-5px) scale(1.05); } }
        .stage-icon { width: 120px; height: 120px; margin: 0 auto 16px; position: relative; background: #E8F5E9; border: 4px solid #333; box-shadow: 0 0 0 2px #666, 6px 6px 0 0 rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 64px; transition: all 0.3s ease; overflow: hidden; }
        .stage-node.locked .stage-icon, .stage-node.current .stage-icon { background: #9E9E9E; }
        .stage-node.completed .stage-icon { background: #FFF9C4; box-shadow: 0 0 0 2px #FFD700, 6px 6px 0 0 rgba(0,0,0,0.3), 0 0 20px rgba(255,215,0,0.5); }
        .stage-icon img.icon-image { width: 64px; height: 64px; object-fit: contain; image-rendering: pixelated; display: block; transition: filter 0.3s ease; filter: grayscale(1); }
        .stage-node.completed .stage-icon img.icon-image { filter: grayscale(0); }
        .stage-node.locked .stage-icon img.icon-image { filter: grayscale(1); opacity: 0.7; }
        .stage-icon .icon-fallback { font-size: 64px; display: none; filter: grayscale(1); }
        .stage-node.completed .stage-icon .icon-fallback { filter: grayscale(0); }
        .stage-node.locked .stage-icon .icon-fallback { filter: grayscale(1); opacity: 0.7; }
        .clear-effect { position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; object-fit: contain; display: none; z-index: 2; animation: effect-animation 2s ease-in-out infinite; }
        .stage-node.completed .clear-effect { display: block; }
        @keyframes effect-animation { 0%, 100% { transform: translateY(0) scale(1) rotate(0deg); opacity: 0.9; } 25% { transform: translateY(-5px) scale(1.1) rotate(5deg); opacity: 1; } 50% { transform: translateY(0) scale(1) rotate(0deg); opacity: 0.9; } 75% { transform: translateY(-3px) scale(1.05) rotate(-5deg); opacity: 1; } }
        .clear-badge { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background: #FFD700; border: 3px solid #B8860B; padding: 4px 12px; font-weight: bold; font-size: 14px; color: #654321; letter-spacing: 1px; box-shadow: 0 0 0 1px #DAA520, 3px 3px 0 0 rgba(0,0,0,0.5); z-index: 10; animation: bounce-in 0.5s ease; display: none; }
        .stage-node.completed .clear-badge { display: block; }
        @keyframes bounce-in { 0% { transform: translateX(-50%) translateY(-20px) scale(0); } 50% { transform: translateX(-50%) translateY(0) scale(1.2); } 100% { transform: translateX(-50%) translateY(0) scale(1); } }
        .stage-number-badge { position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); width: 44px; height: 44px; background: #4DB6F7; border: 3px solid #2C88C7; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; color: white; box-shadow: 0 0 0 1px #5AC8F7, 3px 3px 0 0 rgba(0,0,0,0.3); z-index: 5; padding: 2px; }
        .stage-number-badge::before { content: ''; width: 6px; height: 6px; background: white; border-radius: 50%; position: absolute; top: 8px; left: 10px; box-shadow: 0 0 0 1px #2C88C7; }
        .stage-number-badge::after { content: ''; width: 6px; height: 6px; background: white; border-radius: 50%; position: absolute; top: 8px; right: 10px; box-shadow: 0 0 0 1px #2C88C7; }
        .stage-number-text { margin-top: 14px; }
        .stage-node.locked .stage-number-badge { background: #757575; border-color: #616161; box-shadow: 0 0 0 1px #9E9E9E, 3px 3px 0 0 rgba(0,0,0,0.3); }
        .stage-node.locked .stage-number-badge::before, .stage-node.locked .stage-number-badge::after { background: #ccc; box-shadow: 0 0 0 1px #616161; }
        .stage-node.completed .stage-number-badge { background: #8EE38F; border-color: #6CBD6C; }
        .stage-node.completed .stage-number-badge::before, .stage-node.completed .stage-number-badge::after { box-shadow: 0 0 0 1px #6CBD6C; }
        .hero-face { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); width: 40px; height: 40px; background-color: #FFEB3B; border: 3px solid #FBC02D; border-radius: 50%; z-index: 20; display: none; box-shadow: 2px 2px 0 rgba(0,0,0,0.2); animation: hero-face-bounce 1.5s ease-in-out infinite; }
        .hero-face::before, .hero-face::after { content: ''; position: absolute; width: 6px; height: 8px; background-color: #333; border-radius: 3px / 4px; top: 12px; }
        .hero-face::before { left: 9px; }
        .hero-face::after { right: 9px; }
        .hero-face .mouth { position: absolute; width: 16px; height: 2px; background-color: #333; bottom: 10px; left: 50%; transform: translateX(-50%); border-radius: 1px; }
        .stage-node.current .hero-face { display: block; }
        @keyframes hero-face-bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-4px); } }
        .stage-info { background: white; border: 3px solid #333; padding: 12px 16px; margin-top: 16px; position: relative; box-shadow: 0 0 0 1px #666, 4px 4px 0 0 rgba(0,0,0,0.2); }
        .stage-title { font-size: 1.1rem; font-weight: bold; color: #333; margin-bottom: 4px; }
        .stage-description { font-size: 0.9rem; color: #666; line-height: 1.4; }
        .path-line { position: absolute; width: 60px; height: 4px; background: repeating-linear-gradient( 90deg, #8B4513, #8B4513 10px, #D2691E 10px, #D2691E 20px ); top: 60px; right: -60px; transform: translateY(-50%); z-index: 1; }
        .stage-node:nth-child(3n) .path-line, .stage-node:last-child .path-line { display: none; }
        @media (max-width: 767px) { .stage-node:nth-child(3n) .path-line { display: block; } .stage-node:nth-child(2n) .path-line, .stage-node:last-child .path-line { display: none; } }
        .quest-button { position: fixed; bottom: 30px; right: 30px; width: auto; min-width: 200px; margin: 0; padding: 16px 32px; background: #FF6B6B; border: 4px solid #DC143C; color: white; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 0 0 2px #FF8787, 6px 6px 0 0 rgba(0,0,0,0.3); transition: all 0.1s ease; animation: pulse_button 2s ease-in-out infinite; z-index: 900; }
        @keyframes pulse_button { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .quest-button:hover { transform: translate(-2px, -2px) scale(1.02); box-shadow: 0 0 0 2px #FF8787, 8px 8px 0 0 rgba(0,0,0,0.3); animation: none; }
        .quest-button:active { transform: translate(2px, 2px); box-shadow: 0 0 0 2px #FF8787, 2px 2px 0 0 rgba(0,0,0,0.3); }
        @media (max-width: 767px) { .quest-button { padding: 12px 24px; font-size: 1rem; bottom: 20px; right: 20px; min-width: 160px; } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1001; align-items: center; justify-content: center; }
        .modal-content { background: #F5F5DC; border: 4px solid #8B4513; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 0 0 2px #A0522D, 8px 8px 0 0 rgba(0,0,0,0.5); position: relative; }
        .modal-close { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; background: #DC143C; border: 2px solid #8B0000; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; font-weight: bold; box-shadow: 2px 2px 0 0 rgba(0,0,0,0.5); }
        .modal-close:hover { transform: translate(-1px, -1px); box-shadow: 3px 3px 0 0 rgba(0,0,0,0.5); }
        .modal-close:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0 0 rgba(0,0,0,0.5); }
        .modal-title { font-size: 1.6rem; color: #8B4513; margin-bottom: 16px; font-weight: bold; text-align: center; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
        .modal-description { color: #654321; margin-bottom: 20px; line-height: 1.6; text-align: center; }
        .modal-message { background: #FFF9C4; border: 2px solid #F9A825; padding: 16px; margin-bottom: 24px; text-align: center; font-style: italic; color: #5D4037; box-shadow: inset 0 0 8px rgba(0,0,0,0.1); }
        .modal-buttons { display: flex; gap: 16px; justify-content: center; }
        @media (max-width: 767px) { .modal-buttons { flex-direction: column; } }
        .modal-button { flex: 1; padding: 12px 24px; border: 3px solid; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.1s ease; position: relative; }
        .modal-button.video { background: #4CAF50; border-color: #388E3C; color: white; box-shadow: 0 0 0 1px #66BB6A, 4px 4px 0 0 rgba(0,0,0,0.3); }
        .modal-button.video:hover { transform: translate(-2px, -2px); box-shadow: 0 0 0 1px #66BB6A, 6px 6px 0 0 rgba(0,0,0,0.3); }
        .modal-button.quest { background: #2196F3; border-color: #1976D2; color: white; box-shadow: 0 0 0 1px #42A5F5, 4px 4px 0 0 rgba(0,0,0,0.3); }
        .modal-button.quest:hover { transform: translate(-2px, -2px); box-shadow: 0 0 0 1px #42A5F5, 6px 6px 0 0 rgba(0,0,0,0.3); }
        .modal-button:active { transform: translate(1px, 1px); box-shadow: 0 0 0 1px currentColor, 2px 2px 0 0 rgba(0,0,0,0.3); }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .loading-content { text-align: center; background: #F5F5DC; padding: 30px; border: 4px solid #8B4513; box-shadow: 0 0 0 2px #A0522D, 8px 8px 0 0 rgba(0,0,0,0.5); }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #4DB6F7; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        .loading-content p { color: #654321; font-weight: bold; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„ÅØnavigation.css„ÅßÁµ±‰∏ÄÁÆ°ÁêÜ */

    </style>
</head>
<body class="quest-page">
    <!-- ÂõûËª¢‰øÉÈÄ≤„É°„ÉÉ„Çª„Éº„Ç∏ -->
    <div class="rotation-notice">
        <div class="rotation-notice-icon">üì±</div>
        <h2>Ê®™ÁîªÈù¢„Åß„ÅäÊ•Ω„Åó„Åø„Åè„Å†„Åï„ÅÑ</h2>
        <p>„Åì„ÅÆ„Ç¢„Éó„É™„ÅØÊ®™ÁîªÈù¢„Åß„ÅÆ„ÅîÂà©Áî®„ÇíÊé®Â•®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ<br>„Çπ„Éû„Éº„Éà„Éï„Ç©„É≥„ÇíÊ®™Âêë„Åç„Å´„Åó„Å¶„ÅäÊ•Ω„Åó„Åø„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
    </div>

    <!-- „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº -->
    <div class="hamburger-menu" id="hamburgerMenu">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </div>

    <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">üéÆ CLAFT</div>
        </div>
        <div class="sidebar-nav">
            <ul>
                <li><a href="index.html"><i class="fas fa-home"></i><span class="nav-label">„Éõ„Éº„É†</span></a></li>
                <li><a href="quest.html" class="active"><i class="fas fa-map"></i><span class="nav-label">„ÇØ„Ç®„Çπ„Éà„Éû„ÉÉ„Éó</span></a></li>
                <li><a href="yononaka.html"><i class="fas fa-globe"></i><span class="nav-label">Yononaka</span></a></li>
                <li><a href="mirai.html"><i class="fas fa-rocket"></i><span class="nav-label">„Éü„É©„Ç§„ÇØ„É©„Éï„Éà</span></a></li>
                <li><a href="admin.html" style="display: none;" class="admin-link"><i class="fas fa-cog"></i><span class="nav-label">ÁÆ°ÁêÜÁîªÈù¢</span></a></li>
            </ul>
        </div>
    </nav>

    <!-- „Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Ë™çË®º„Éú„Çø„É≥Áî®„Çπ„Éö„Éº„Çπ -->
    <div class="nav-buttons"></div>

    <div id="skyObjectsContainer"></div>
    <div class="loading-overlay" id="loadingOverlay"> <div class="loading-content"> <div class="loading-spinner"></div> <p>ÂÜíÈô∫„ÅÆÊ∫ñÂÇô‰∏≠...</p> </div> </div>
    
    <div class="container">
        <header class="map-header"> <h1>üó∫Ô∏è CLAFT „ÇØ„Ç®„Çπ„Éà„Éû„ÉÉ„Éó</h1> <p>„Åç„Åø„Å†„Åë„ÅÆÂÜíÈô∫Áâ©Ë™û„Çí„Å§„Åè„Çç„ÅÜÔºÅ</p> <button class="adventure-log-button" id="adventureLogBtn"> „Åì„Çå„Åæ„Åß„ÅÆÂÜíÈô∫„ÇíÊåØ„ÇäËøî„Çã </button> </header>
        <div class="stage-grid" id="stageGrid">
            <!-- „Çπ„ÉÜ„Éº„Ç∏1 -->
            <div class="stage-node" id="stage-1" data-stage-id="1">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-face"><div class="mouth"></div></div> 
                <div class="stage-icon">
                    <img class="icon-image" src="" alt="„Çπ„ÉÜ„Éº„Ç∏1„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üè†</span>
                    <img class="clear-effect" src="" alt="ÁÖô„Ç®„Éï„Çß„ÇØ„Éà" data-effect-type="smoke">
                </div>
                <div class="stage-number-badge"><span class="stage-number-text">1</span></div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
                <div class="path-line"></div>
            </div>
            <!-- „Çπ„ÉÜ„Éº„Ç∏2 -->
            <div class="stage-node" id="stage-2" data-stage-id="2">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-face"><div class="mouth"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="" alt="„Çπ„ÉÜ„Éº„Ç∏2„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üå≤</span>
                    <img class="clear-effect" src="" alt="ÂãïÁâ©„Ç®„Éï„Çß„ÇØ„Éà" data-effect-type="animal">
                </div>
                <div class="stage-number-badge"><span class="stage-number-text">2</span></div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
                <div class="path-line"></div>
            </div>
            <!-- „Çπ„ÉÜ„Éº„Ç∏3 -->
            <div class="stage-node" id="stage-3" data-stage-id="3">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-face"><div class="mouth"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="" alt="„Çπ„ÉÜ„Éº„Ç∏3„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">‚öîÔ∏è</span>
                </div>
                <div class="stage-number-badge"><span class="stage-number-text">3</span></div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
                <div class="path-line"></div>
            </div>
            <!-- „Çπ„ÉÜ„Éº„Ç∏4 -->
            <div class="stage-node" id="stage-4" data-stage-id="4">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-face"><div class="mouth"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="" alt="„Çπ„ÉÜ„Éº„Ç∏4„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üõ°Ô∏è</span>
                </div>
                <div class="stage-number-badge"><span class="stage-number-text">4</span></div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
                <div class="path-line"></div>
            </div>
            <!-- „Çπ„ÉÜ„Éº„Ç∏5 -->
            <div class="stage-node" id="stage-5" data-stage-id="5">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-face"><div class="mouth"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="" alt="„Çπ„ÉÜ„Éº„Ç∏5„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üë•</span>
                </div>
                <div class="stage-number-badge"><span class="stage-number-text">5</span></div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
                <div class="path-line"></div>
            </div>
            <!-- „Çπ„ÉÜ„Éº„Ç∏6 -->
            <div class="stage-node" id="stage-6" data-stage-id="6">
                <div class="clear-badge">CLEAR!</div>
                <div class="hero-face"><div class="mouth"></div></div>
                <div class="stage-icon">
                    <img class="icon-image" src="" alt="„Çπ„ÉÜ„Éº„Ç∏6„Ç¢„Ç§„Ç≥„É≥" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="icon-fallback">üè∞</span>
                </div>
                <div class="stage-number-badge"><span class="stage-number-text">6</span></div>
                <div class="stage-info"><h3 class="stage-title"></h3><p class="stage-description"></p></div>
            </div>
        </div>
    </div>
    <button class="quest-button" id="mainQuestButton">üî• Ê¨°„ÅÆÂÜíÈô∫„Å∏ÈÄ≤„ÇÄÔºÅ</button>
    <div class="modal" id="stageModal"> <div class="modal-content"> <button class="modal-close" id="modalCloseBtn">√ó</button> <h2 class="modal-title" id="modalStageTitle"></h2> <p class="modal-description" id="modalStageDescription"></p> <div class="modal-message" id="modalStageMessage"></div> <div class="modal-buttons"> <button class="modal-button video" id="modalVideoBtn">üé¨ ÂãïÁîª„ÇíË¶ã„Çã</button> <button class="modal-button quest" id="modalQuestBtn">‚öîÔ∏è „ÇØ„Ç®„Çπ„Éà„Å´Êåë„ÇÄ</button> </div> </div> </div>
    
    <!-- ÈáçË§á„Åó„Å¶„ÅÑ„ÇãSupabase„ÅÆË™≠„ÅøËæº„Åø„ÇíÂâäÈô§ -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> -->
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÅÆÊõ¥Êñ∞
        let currentUserId = null;
        let userProgress = {};
        let currentStageIdForModal = null;

        // Ë™çË®ºÁä∂ÊÖã„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Å®„Åç„ÅÆÂá¶ÁêÜ
        window.onAuthStateChanged = async function(user) {
            if (user) {
                currentUserId = user.id;
                await initializeQuestMap();
            } else {
                currentUserId = null;
                // „Éá„É¢„Éá„Éº„Çø„Åß„ÇØ„Ç®„Çπ„Éà„Éû„ÉÉ„Éó„ÇíË°®Á§∫
                showDemoQuestMap();
            }
        };

        const TOTAL_STAGES = 6;
        const NUM_SKY_OBJECTS = 7;

        const stageStaticData = {
            1: { 
                title: 'Âêõ„ÅØ„Å©„Çì„Å™ÂÜíÈô∫ËÄÖÔºü', 
                description: '„ÄúÂ≠¶„Å≥„ÅÆÂú∞Âõ≥„Çí„Å≤„Çâ„Åì„ÅÜ„Äú', 
                message: '„ÄåÂãâÂº∑„Å®„ÅÑ„ÅÜ‰∫åÊñáÂ≠ó„ÇíÂøò„Çå„Çà„ÅÜ„Äç',
                videoUrl: 'https://vimeo.com/1096785134/fc1a254212',
                formUrl: 'https://forms.gle/DX3GDXH9E62wVWTz7',
                iconImage: 'https://via.placeholder.com/64x64/8B4513/FFFFFF?text=House', 
                fallbackIcon: 'üè†', 
                clearEffectImage: 'https://via.placeholder.com/32x32/CCCCCC/000000?text=Smoke' 
            },
            2: { 
                title: 'Êñ∞ÊôÇ‰ª£„ÅÆÂÜíÈô∫ËÄÖ„Å´ÂøÖË¶Å„Å™„ÇÇ„ÅÆ„Å£„Å¶Ôºü', 
                description: '„ÄúÊ≠¶Âô®„Å®ÈÅìÂÖ∑„ÅÆË©±„Äú', 
                message: '„ÄåÂêõ„ÅØÊ≠¶Âô®„ÇÑÈÅìÂÖ∑„Çí„Å©„ÅÜ‰Ωø„ÅÜÔºü„Äç',
                videoUrl: 'https://youtube.com/watch?v=stage2video',
                formUrl: 'https://forms.google.com/your-form-2',
                iconImage: 'https://via.placeholder.com/64x64/228B22/FFFFFF?text=Forest', 
                fallbackIcon: 'üå≤', 
                clearEffectImage: 'https://via.placeholder.com/32x32/8B4513/FFFFFF?text=Animal' 
            },
            3: { 
                title: 'Âêõ„ÅØ„Å©„Çì„Å™„Ç≠„É£„É©Ôºü', 
                description: '„ÄúËá™ÂàÜ„ÇíËÇ≤„Å¶„ÇãËÇ≤Êàê„Ç≤„Éº„É†„Äú', 
                message: '„ÄåËá™ÂàÜ„ÅÆ„Ç≠„É£„É©„ÅØ„ÄÅËá™ÂàÜ„ÅßÊ±∫„ÇÅ„Çà„ÅÜ„Äç',
                videoUrl: 'https://youtube.com/watch?v=stage3video',
                formUrl: 'https://forms.google.com/your-form-3',
                iconImage: 'https://via.placeholder.com/64x64/4169E1/FFFFFF?text=Sword', 
                fallbackIcon: '‚öîÔ∏è', 
                clearEffectImage: null 
            },
            4: { 
                title: '„Å°„Åå„ÅÜ„Å£„Å¶„ÄÅ„Åä„ÇÇ„Åó„Çç„ÅÑ', 
                description: '„ÄúÊ≠£Ëß£„Åå„Å™„ÅÑ„Åã„ÇâÂ∫É„Åå„Çã‰∏ñÁïå„Äú', 
                message: '„Äå„Å†„Çå„Åã„Å®ÈÅï„ÅÜ„ÅÆ„ÅØÊÄñ„ÅÑ„Åì„Å®„Åò„ÇÉ„Å™„ÅÑ„Äç',
                videoUrl: 'https://youtube.com/watch?v=stage4video',
                formUrl: 'https://forms.google.com/your-form-4',
                iconImage: 'https://via.placeholder.com/64x64/FFD700/000000?text=Shield', 
                fallbackIcon: 'üõ°Ô∏è', 
                clearEffectImage: null 
            },
            5: { 
                title: '„ÄåÔºü„Äç„Åå‰∏ñÁïå„Çí„Å≤„Çâ„Åè', 
                description: '„Äú„ÉØ„ÇØ„ÉØ„ÇØÔºÜ„ÇÇ„ÇÑ„ÇÇ„ÇÑ„Äú', 
                message: '„Äå‚Äú„ÇÇ„ÇÑ„ÇÇ„ÇÑ‚Äù„Åå„Ç¢„Ç§„Éá„Ç¢„Çí„Å§„Åè„ÇãÔºÅÔºÅ„Äç',
                videoUrl: 'https://youtube.com/watch?v=stage5video',
                formUrl: 'https://forms.google.com/your-form-5',
                iconImage: 'https://via.placeholder.com/64x64/32CD32/FFFFFF?text=Team', 
                fallbackIcon: 'üë•', 
                clearEffectImage: null 
            },
            6: { 
                title: '„Å§„Åè„Å£„Å¶„Å§„Åü„Åà„Çã„Å®Ê∞ó„Å•„Åë„Çã', 
                description: '„ÄúÈÅï„ÅÑ„ÇíÁîü„Åã„Åó„Å¶Êú™Êù•„ÇíÂâµ„Çã„Äú', 
                message: '„ÄåÂ∞è„Åï„Å™‰∏ÄÊ≠©„Åå„ÄÅÂ§ß„Åç„Å™Êú™Êù•„Å´„Å§„Å™„Åå„Çã„Äç',
                videoUrl: 'https://youtube.com/watch?v=stage6video',
                formUrl: 'https://forms.google.com/your-form-6',
                iconImage: 'https://via.placeholder.com/64x64/8B0000/FFFFFF?text=Boss', 
                fallbackIcon: 'üè∞', 
                clearEffectImage: null 
            }
        };
        
        const loadingOverlay = document.getElementById('loadingOverlay');
        const stageGrid = document.getElementById('stageGrid');
        const mainQuestButton = document.getElementById('mainQuestButton');
        const stageModal = document.getElementById('stageModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalStageTitle = document.getElementById('modalStageTitle');
        const modalStageDescription = document.getElementById('modalStageDescription');
        const modalStageMessage = document.getElementById('modalStageMessage');
        const modalVideoBtn = document.getElementById('modalVideoBtn');
        const modalQuestBtn = document.getElementById('modalQuestBtn');
        const skyObjectsContainer = document.getElementById('skyObjectsContainer');
        
        function createSkyObjects() {
            skyObjectsContainer.innerHTML = ''; 
            for (let i = 0; i < NUM_SKY_OBJECTS; i++) {
                const obj = document.createElement('div');
                obj.classList.add('sky-object');
                let type;
                const randomValue = Math.random();
                if (randomValue < 0.95) { type = 'cloud'; } else { type = 'ufo'; }
                obj.classList.add(type);
                obj.style.top = `${Math.random() * 70 + 5}%`; 
                const duration = Math.random() * 25 + 20; 
                obj.style.animationDuration = `${duration}s`;
                const startY = Math.random() * 10 - 5; 
                const endY = Math.random() * 10 - 5;
                obj.style.setProperty('--sy', `${startY}px`);
                obj.style.setProperty('--ey', `${endY}px`);
                if (Math.random() < 0.5) { obj.style.left = `-${Math.random() * 100 + 100}px`; obj.style.animationName = 'float-sky-ltr'; } 
                else { obj.style.right = `-${Math.random() * 100 + 100}px`; obj.style.animationName = 'float-sky-rtl'; }
                obj.style.animationDelay = `${Math.random() * duration * 0.8}s`; 
                skyObjectsContainer.appendChild(obj);
            }
        }
        
        // „ÇØ„Ç®„Çπ„Éà„Éû„ÉÉ„Éó„ÅÆÂàùÊúüÂåñ
        let currentUser = null; 

        // „ÇØ„Ç®„Çπ„Éà„Éû„ÉÉ„Éó„ÅÆÂàùÊúüÂåñ
        async function initializeQuestMap() {
            if (!currentUserId) return;
            
            showLoading(true);
            userProgress = await fetchUserProgress(currentUserId);
            updateStageDisplay();
            showLoading(false);
        }

        // „ÇØ„Ç®„Çπ„Éà„Éû„ÉÉ„Éó„ÅÆ„É™„Çª„ÉÉ„Éà
        function resetQuestMap() {
            for (let i = 1; i <= TOTAL_STAGES; i++) {
                userProgress[i] = 'locked';
            }
            updateStageDisplay();
        }

        // „Éá„É¢Áî®„ÅÆ„ÇØ„Ç®„Çπ„Éà„Éû„ÉÉ„ÉóË°®Á§∫Èñ¢Êï∞
        function showDemoQuestMap() {
            // „Éá„É¢Áî®„ÅÆÈÄ≤Êçó„Éá„Éº„ÇøÔºà„Çπ„ÉÜ„Éº„Ç∏1„ÅÆ„Åø„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩÔºâ
            userProgress = {
                1: 'current',  // „Çπ„ÉÜ„Éº„Ç∏1„ÅØÊú™„É≠„Ç∞„Ç§„É≥„Åß„ÇÇ‰ΩìÈ®ìÂèØËÉΩ
                2: 'locked',
                3: 'locked',
                4: 'locked',
                5: 'locked',
                6: 'locked'
            };
            
            updateStageDisplay();
            
            // „É°„Ç§„É≥„ÇØ„Ç®„Çπ„Éà„Éú„Çø„É≥„Çí„Çπ„ÉÜ„Éº„Ç∏1‰ΩìÈ®ìÁî®„Å´Â§âÊõ¥
            const mainQuestButton = document.getElementById('mainQuestButton');
            if (mainQuestButton) {
                mainQuestButton.textContent = 'üåü „Çπ„ÉÜ„Éº„Ç∏1„Çí‰ΩìÈ®ì„Åó„Å¶„Åø„Çã';
                mainQuestButton.onclick = () => openStageModal(1);
            }
        }
        
        function showLoading(show) { 
            loadingOverlay.style.display = show ? 'flex' : 'none'; 
        }
        
        // „É¶„Éº„Ç∂„ÉºÈÄ≤Ë°åÁä∂Ê≥Å„ÅÆÂèñÂæóÔºàÊõ¥Êñ∞ÁâàÔºâ
        async function fetchUserProgress(userId) {
            showLoading(true);
            console.log(`Fetching progress for userId: ${userId}`);
            
            try {
                const { data, error } = await supabase
                    .from('quest_progress')
                    .select('*')
                    .eq('user_id', userId);
                    
                if (error) throw error;
                
                const progress = {};
                
                // ÂàùÊúüÁä∂ÊÖãÔºö„Çπ„ÉÜ„Éº„Ç∏1„ÅØcurrent„ÄÅ‰ªñ„ÅØlocked
                for (let i = 1; i <= TOTAL_STAGES; i++) {
                    progress[i] = i === 1 ? 'current' : 'locked';
                }
                
                // „Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆÁä∂ÊÖã„Åß‰∏äÊõ∏„Åç
                if (data && data.length > 0) {
                    data.forEach(record => {
                        progress[record.stage_id] = record.status;
                    });
                    
                    // Ê¨°„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÇíËá™ÂãïÁöÑ„Å´current„Å´
                    let hasCurrentStage = false;
                    for (let i = 1; i <= TOTAL_STAGES; i++) {
                        if (progress[i] === 'current' || progress[i] === 'pending_approval') {
                            hasCurrentStage = true;
                            break;
                        }
                    }
                    
                    if (!hasCurrentStage) {
                        // ÊúÄÂæå„Å´completed„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Çπ„ÉÜ„Éº„Ç∏„ÅÆÊ¨°„Çícurrent„Å´
                        for (let i = TOTAL_STAGES - 1; i >= 1; i--) {
                            if (progress[i] === 'completed' && i < TOTAL_STAGES) {
                                progress[i + 1] = 'current';
                                break;
                            }
                        }
                    }
                }
                
                console.log('Progress fetched:', progress);
                return progress;
                
            } catch (error) {
                console.error('Error fetching user progress:', error.message);
                const defaultProgress = {};
                for (let i = 1; i <= TOTAL_STAGES; i++) {
                    defaultProgress[i] = i === 1 ? 'current' : 'locked';
                }
                return defaultProgress;
            } finally {
                showLoading(false);
            }
        }

        // „É¶„Éº„Ç∂„ÉºÈÄ≤Ë°åÁä∂Ê≥Å„ÅÆ‰øùÂ≠òÔºàÊõ¥Êñ∞ÁâàÔºâ
        async function saveUserProgress(userId, stageId, newStatus, additionalData = {}) {
            showLoading(true);
            console.log(`Saving progress for userId: ${userId}, stageId: ${stageId}, status: ${newStatus}`);
            
            try {
                const updateData = {
                    user_id: userId,
                    stage_id: stageId,
                    status: newStatus,
                    updated_at: new Date().toISOString(),
                    ...additionalData
                };
                
                const { data, error } = await supabase
                    .from('quest_progress')
                    .upsert(updateData, {
                        onConflict: 'user_id,stage_id'
                    })
                    .select();
                    
                if (error) throw error;
                
                console.log('Progress saved:', data);
                userProgress[stageId] = newStatus;
                
                // Áµ±Ë®àÊÉÖÂ†±„ÅÆÊõ¥Êñ∞Ôºàcompleted„ÅÆÂ†¥ÂêàÔºâ
                if (newStatus === 'completed') {
                    await updateQuestStats(userId);
                }
                
                return true;
            } catch (error) {
                console.error('Error saving user progress:', error.message);
                return false;
            } finally {
                showLoading(false);
            }
        }

        // „ÇØ„Ç®„Çπ„ÉàÁµ±Ë®à„ÅÆÊõ¥Êñ∞
        async function updateQuestStats(userId) {
            try {
                // ÁèæÂú®„ÅÆÁµ±Ë®à„ÇíÂèñÂæó
                const { data: stats, error: statsError } = await supabase
                    .from('user_stats')
                    .select('*')
                    .eq('user_id', userId)
                    .single();
                    
                if (statsError && statsError.code !== 'PGRST116') throw statsError;
                
                const currentStats = stats || { quest_clear_count: 0, total_exp: 0 };
                
                // „ÇØ„Ç®„Çπ„Éà„ÇØ„É™„Ç¢ÂõûÊï∞„Å®ÁµåÈ®ìÂÄ§„ÇíÊõ¥Êñ∞
                const { error: updateError } = await supabase
                    .from('user_stats')
                    .upsert({
                        user_id: userId,
                        quest_clear_count: currentStats.quest_clear_count + 1,
                        total_exp: currentStats.total_exp + 100, // 1„ÇØ„Ç®„Çπ„Éà„ÇØ„É™„Ç¢„Åß100EXP
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });
                    
                if (updateError) throw updateError;
                
            } catch (error) {
                console.error('Error updating quest stats:', error);
            }
        }
        
        // „Çπ„ÉÜ„Éº„Ç∏Ë°®Á§∫„ÅÆÊõ¥Êñ∞Ôºàpending_approvalÂØæÂøúÔºâ
        function updateStageDisplay() {
            let currentStageExists = false;
            let allStagesCompleted = true;
            
            for (let i = 1; i <= TOTAL_STAGES; i++) {
                const stageNode = document.getElementById(`stage-${i}`);
                if (!stageNode) continue;
                
                const status = userProgress[i] || 'locked';
                
                // „ÇØ„É©„Çπ„ÅÆÊõ¥Êñ∞
                stageNode.classList.remove('completed', 'current', 'locked', 'pending');
                if (status === 'pending_approval') {
                    stageNode.classList.add('current', 'pending');
                } else {
                    stageNode.classList.add(status);
                }
                
                if (status !== 'completed') {
                    allStagesCompleted = false;
                }
                
                // Êó¢Â≠ò„ÅÆË°®Á§∫Êõ¥Êñ∞Âá¶ÁêÜ...
                const staticInfo = stageStaticData[i];
                stageNode.querySelector('.stage-title').textContent = staticInfo.title;
                stageNode.querySelector('.stage-description').textContent = staticInfo.description;
                
                // „Éí„Éº„É≠„Éº„Éï„Çß„Ç§„Çπ„ÅÆË°®Á§∫
                const heroFace = stageNode.querySelector('.hero-face');
                if (heroFace) {
                    if (status === 'current' || status === 'pending_approval') {
                        heroFace.style.display = 'block';
                        currentStageExists = true;
                    } else {
                        heroFace.style.display = 'none';
                    }
                }
                
                // ÊâøË™çÂæÖ„Å°„Éê„ÉÉ„Ç∏„ÅÆËøΩÂä†
                if (status === 'pending_approval') {
                    let pendingBadge = stageNode.querySelector('.pending-badge');
                    if (!pendingBadge) {
                        pendingBadge = document.createElement('div');
                        pendingBadge.className = 'pending-badge';
                        pendingBadge.textContent = 'ÊâøË™çÂæÖ„Å°';

                        stageNode.appendChild(pendingBadge);
                    }
                } else {
                    const pendingBadge = stageNode.querySelector('.pending-badge');
                    if (pendingBadge) {
                        pendingBadge.remove();
                    }
                }
            }
            
            // „É°„Ç§„É≥„ÇØ„Ç®„Çπ„Éà„Éú„Çø„É≥„ÅÆÊõ¥Êñ∞
            updateMainQuestButton(allStagesCompleted, currentStageExists);
        }

        // „É°„Ç§„É≥„ÇØ„Ç®„Çπ„Éà„Éú„Çø„É≥„ÅÆÊõ¥Êñ∞
        function updateMainQuestButton(allCompleted, hasCurrentStage) {
            const mainQuestButton = document.getElementById('mainQuestButton');
            
            if (allCompleted && Object.keys(userProgress).length >= TOTAL_STAGES) {
                mainQuestButton.textContent = 'üéâ ÂÖ®„Å¶„ÅÆÂÜíÈô∫„ÇíÈÅîÊàêÔºÅ';
                mainQuestButton.disabled = true;
            } else if (!hasCurrentStage && !allCompleted && Object.keys(userProgress).length > 0) {
                mainQuestButton.textContent = '‚ùì Ê¨°„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Å∏';
                mainQuestButton.disabled = false;
            } else if (!currentUserId) {
                mainQuestButton.textContent = 'üåü „Çπ„ÉÜ„Éº„Ç∏1„Çí‰ΩìÈ®ì„Åó„Å¶„Åø„Çã';
                mainQuestButton.disabled = false;
                // onclickÂá¶ÁêÜ„ÅØ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅßÁµ±‰∏ÄÁÆ°ÁêÜ
            } else {
                mainQuestButton.textContent = 'üî• Ê¨°„ÅÆÂÜíÈô∫„Å∏ÈÄ≤„ÇÄÔºÅ';
                mainQuestButton.disabled = false;
            }
        }

        // „É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅèÔºàÊõ¥Êñ∞ÁâàÔºâ
        function openStageModal(stageId) {
            const status = userProgress[stageId];
            
            // „Çπ„ÉÜ„Éº„Ç∏1„ÅØÊú™„É≠„Ç∞„Ç§„É≥„Åß„ÇÇ„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„ÄÅ‰ªñ„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÅØlockedÊôÇ„ÅØÊãíÂê¶
            if (status === 'locked' && stageId !== 1) {
                alert('„Åì„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÅØ„Åæ„Å†ÈñãÊîæ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºÅ');
                return;
            }
            
            // „Çπ„ÉÜ„Éº„Ç∏1„ÅßÊú™„É≠„Ç∞„Ç§„É≥„ÅÆÂ†¥Âêà„ÅÆÁâπÂà•Âá¶ÁêÜ
            if (stageId === 1 && !currentUserId) {
                openStage1GuestModal();
                return;
            }
            
            currentStageIdForModal = stageId;
            const staticInfo = stageStaticData[stageId];
            
            modalStageTitle.textContent = `„Çπ„ÉÜ„Éº„Ç∏ ${stageId}: ${staticInfo.title}`;
            modalStageDescription.textContent = staticInfo.description;
            modalStageMessage.textContent = staticInfo.message;
            
            // „Éú„Çø„É≥„ÅÆË°®Á§∫Âà∂Âæ°
            const videoBtn = document.getElementById('modalVideoBtn');
            const questBtn = document.getElementById('modalQuestBtn');
            
            if (status === 'current') {
                // ÂãïÁîª„Éú„Çø„É≥„ÅÆË°®Á§∫„Å®Ë®≠ÂÆö
                videoBtn.style.display = 'block';
                videoBtn.textContent = 'üé¨ ÂãïÁîª„ÇíË¶ã„Çã';
                videoBtn.disabled = false;
                
                // „ÅäÈ°å„Éú„Çø„É≥„ÅÆË°®Á§∫„Å®Ë®≠ÂÆö
                questBtn.style.display = 'block';
                questBtn.textContent = '‚öîÔ∏è „ÇØ„Ç®„Çπ„Éà„Å´Êåë„ÇÄ';
                questBtn.disabled = false;
                
                // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº„ÅÆË®≠ÂÆö„ÅØstartQuestÈñ¢Êï∞ÂÜÖ„ÅßË°å„ÅÜ
                startQuest(stageId);
            } else if (status === 'pending_approval') {
                videoBtn.style.display = 'none';
                questBtn.style.display = 'block';
                questBtn.textContent = '‚è≥ ÊâøË™çÂæÖ„Å°';
                questBtn.disabled = true;
            } else if (status === 'completed') {
                videoBtn.style.display = 'none';
                questBtn.style.display = 'none';
            }
            
            stageModal.style.display = 'flex';
        }

        // „Çπ„ÉÜ„Éº„Ç∏1„ÅÆ„Ç≤„Çπ„ÉàÁî®„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function openStage1GuestModal() {
            currentStageIdForModal = 1;
            const staticInfo = stageStaticData[1];
            
            modalStageTitle.textContent = `„Çπ„ÉÜ„Éº„Ç∏ 1: ${staticInfo.title}`;
            modalStageDescription.textContent = staticInfo.description;
            modalStageMessage.textContent = staticInfo.message;
            
            // „Éú„Çø„É≥„ÅÆË°®Á§∫Âà∂Âæ°Ôºà„Ç≤„Çπ„ÉàÁî®Ôºâ
            const videoBtn = document.getElementById('modalVideoBtn');
            const questBtn = document.getElementById('modalQuestBtn');
            
            videoBtn.style.display = 'block';
            videoBtn.textContent = 'üé¨ ÂãïÁîª„ÇíË¶ã„Çã';
            videoBtn.disabled = false;
            
            questBtn.style.display = 'block';
            questBtn.textContent = '‚öîÔ∏è „ÇØ„Ç®„Çπ„Éà„Å´Êåë„ÇÄ';
            questBtn.disabled = false;
            
            // „Ç≤„Çπ„ÉàÁî®„ÅÆ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„ÉºË®≠ÂÆö
            setupGuestStage1Handlers();
            
            stageModal.style.display = 'flex';
        }

        // „Ç≤„Çπ„ÉàÁî®„Çπ„ÉÜ„Éº„Ç∏1„ÅÆ„Éè„É≥„Éâ„É©„ÉºË®≠ÂÆö
        function setupGuestStage1Handlers() {
            const videoBtn = document.getElementById('modalVideoBtn');
            const questBtn = document.getElementById('modalQuestBtn');
            
            // ÂãïÁîª„Éú„Çø„É≥Ôºö„É≠„Ç∞„Ç§„É≥„Çí‰øÉ„Åô
            videoBtn.onclick = function() {
                closeStageModal();
                setTimeout(() => {
                    if (confirm('ÂãïÁîª„ÇíË¶ñËÅ¥„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åô„ÅãÔºü')) {
                        if (window.authManager) {
                            authManager.showAuthModal();
                        }
                    }
                }, 100);
            };
            
            // „ÇØ„Ç®„Çπ„Éà„Éú„Çø„É≥Ôºö„É≠„Ç∞„Ç§„É≥„Çí‰øÉ„Åô
            questBtn.onclick = function() {
                closeStageModal();
                setTimeout(() => {
                    if (confirm('„ÇØ„Ç®„Çπ„Éà„Å´ÊåëÊà¶„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åô„ÅãÔºü')) {
                        if (window.authManager) {
                            authManager.showAuthModal();
                        }
                    }
                }, 100);
            };
        }

        function closeStageModal() {
            stageModal.style.display = 'none';
            currentStageIdForModal = null;
        }

        // ÂãïÁîªË¶ñËÅ¥„Å®„ÅäÈ°åÊèêÂá∫„ÅÆÂá¶ÁêÜ„ÇíÂÆüË£Ö
        function startQuest(stageId) {
            if (!currentUserId || userProgress[stageId] !== 'current') return;
            
            const staticInfo = stageStaticData[stageId];
            const videoBtn = document.getElementById('modalVideoBtn');
            const questBtn = document.getElementById('modalQuestBtn');
            
            // ÂãïÁîªË¶ñËÅ¥Ê∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const videoWatched = localStorage.getItem(`stage_${stageId}_video_watched`) === 'true';
            
            // ÂãïÁîª„Éú„Çø„É≥„ÅÆÂàùÊúüÁä∂ÊÖã„ÇíË®≠ÂÆö
            if (videoWatched) {
                videoBtn.textContent = '‚úÖ ÂãïÁîªË¶ñËÅ¥Ê∏à„Åø';
                videoBtn.disabled = true;
            }
            
            // ÂãïÁîª„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            videoBtn.onclick = function() {
                // ÂãïÁîªURL„ÇíÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè
                window.open(staticInfo.videoUrl, '_blank');
                
                // ÂãïÁîªË¶ñËÅ¥„Éï„É©„Ç∞„Çí„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
                localStorage.setItem(`stage_${stageId}_video_watched`, 'true');
                
                // „Éú„Çø„É≥„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂ§âÊõ¥
                videoBtn.textContent = '‚úÖ ÂãïÁîªË¶ñËÅ¥Ê∏à„Åø';
                videoBtn.disabled = true;
            };
            
            // „ÅäÈ°å„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            questBtn.onclick = async function() {
                // ÂãïÁîªË¶ñËÅ¥„ÉÅ„Çß„ÉÉ„ÇØ
                const videoWatchedNow = localStorage.getItem(`stage_${stageId}_video_watched`) === 'true';
                if (!videoWatchedNow) {
                    alert('ÂÖà„Å´ÂãïÁîª„ÇíË¶ñËÅ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                // „Éï„Ç©„Éº„É†URL„ÇíÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè
                window.open(staticInfo.formUrl, '_blank');
                
                // „Çπ„ÉÜ„Éº„Çø„Çπ„Çípending_approval„Å´Êõ¥Êñ∞
                const success = await saveUserProgress(currentUserId, stageId, 'pending_approval', {
                    google_form_submitted: true,
                    submitted_at: new Date().toISOString()
                });
                
                if (success) {
                    updateStageDisplay();
                    closeStageModal();
                    
                    setTimeout(() => {
                        alert('„ÅäÈ°å„ÇíÊèêÂá∫„Åó„Åæ„Åó„ÅüÔºÅÁÆ°ÁêÜËÄÖ„ÅÆÊâøË™ç„Çí„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    }, 100);
                } else {
                    alert('ÈÄ≤Êçó„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                }
            };
        }
        

        // Êó¢Â≠ò„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÊõ¥Êñ∞
        document.addEventListener('DOMContentLoaded', function() {
            // Êó¢Â≠ò„ÅÆÂàùÊúüÂåñÂá¶ÁêÜ...
            createSkyObjects();
            
            // authManager„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çã„Åæ„ÅßÂæÖ„Å§
            function waitForAuthManager() {
                if (window.authManager) {
                    // Ë™çË®ºÁä∂ÊÖã„Å´Âü∫„Å•„ÅèÂàùÊúüÂåñ
                    const user = authManager.getCurrentUser();
                    if (user) {
                        initializeQuestMap();
                    } else {
                        showDemoQuestMap();
                    }
                    
                    // „É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
                    modalCloseBtn.addEventListener('click', closeStageModal);
                    stageModal.addEventListener('click', (e) => {
                        if (e.target === stageModal) closeStageModal();
                    });
                    
                    // „Çπ„ÉÜ„Éº„Ç∏„Éé„Éº„Éâ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
                    document.querySelectorAll('.stage-node').forEach(node => {
                        node.addEventListener('click', () => {
                            const stageId = parseInt(node.dataset.stageId);
                            
                            // „Çπ„ÉÜ„Éº„Ç∏1„ÅØÊú™„É≠„Ç∞„Ç§„É≥„Åß„ÇÇ„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ
                            if (stageId === 1 || currentUserId) {
                                openStageModal(stageId);
                            } else {
                                // ‰ªñ„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÅßÊú™„É≠„Ç∞„Ç§„É≥„ÅÆÂ†¥Âêà
                                if (confirm('„Åì„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Å´„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åô„ÅãÔºü')) {
                                    if (window.authManager) {
                                        authManager.showAuthModal();
                                    }
                                }
                            }
                        });
                    });
                    
                    // „É°„Ç§„É≥„ÇØ„Ç®„Çπ„Éà„Éú„Çø„É≥
                    mainQuestButton.addEventListener('click', () => {
                        if (!currentUserId) {
                            // „É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„ÉÜ„Éº„Ç∏1„Çí‰ΩìÈ®ì
                            openStageModal(1);
                            return;
                        }
                        
                        const currentStageEntry = Object.entries(userProgress).find(([_, status]) => 
                            status === 'current' || status === 'pending_approval'
                        );
                        
                        if (currentStageEntry) {
                            openStageModal(parseInt(currentStageEntry[0]));
                        } else if (Object.values(userProgress).every(s => s === 'completed') && Object.keys(userProgress).length >= TOTAL_STAGES) {
                            // ÂÖ®„ÇØ„É™„Ç¢Ê∏à„Åø
                        } else {
                            const firstNonCompleted = Object.entries(userProgress).find(([id, stat]) => 
                                stat === 'locked' || stat === 'current'
                            );
                            if (firstNonCompleted) {
                                openStageModal(parseInt(firstNonCompleted[0]));
                            }
                        }
                    });
                    
                    // ÂÜíÈô∫„É≠„Ç∞„Éú„Çø„É≥
                    document.getElementById('adventureLogBtn').addEventListener('click', showAdventureLog);
                    
                    // „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„ÅÆÂàùÊúüÂåñ„ÇíÁ¢∫ÂÆü„Å´Ë°å„ÅÜ
                    console.log('DOM loaded, initializing hamburger menu');
                    
                    const hamburgerMenu = document.getElementById('hamburgerMenu');
                    const sidebar = document.getElementById('sidebar');
                    const sidebarOverlay = document.getElementById('sidebarOverlay');
                    
                    if (hamburgerMenu && sidebar && sidebarOverlay) {
                        // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÅÆÈáçË§á„ÇíÈò≤„Åê„Åü„ÇÅ„ÄÅÊó¢Â≠ò„ÅÆ„É™„Çπ„Éä„Éº„ÇíÂâäÈô§
                        const newHamburger = hamburgerMenu.cloneNode(true);
                        hamburgerMenu.parentNode.replaceChild(newHamburger, hamburgerMenu);
                        
                        newHamburger.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Hamburger clicked');
                            
                            newHamburger.classList.toggle('active');
                            sidebar.classList.toggle('active');
                            sidebarOverlay.classList.toggle('active');
                        });
                        
                        sidebarOverlay.addEventListener('click', () => {
                            newHamburger.classList.remove('active');
                            sidebar.classList.remove('active');
                            sidebarOverlay.classList.remove('active');
                        });
                        
                        // „Çµ„Ç§„Éâ„Éê„Éº„ÅÆ„É™„É≥„ÇØ„ÇØ„É™„ÉÉ„ÇØ„Åß„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
                        sidebar.querySelectorAll('a').forEach(link => {
                            link.addEventListener('click', () => {
                                newHamburger.classList.remove('active');
                                sidebar.classList.remove('active');
                                sidebarOverlay.classList.remove('active');
                            });
                        });
                    }
                } else {
                    setTimeout(waitForAuthManager, 100);
                }
            }
            
            waitForAuthManager();
        });

        // ÂÜíÈô∫„É≠„Ç∞„ÅÆË°®Á§∫ÔºàÊõ¥Êñ∞ÁâàÔºâ
        function showAdventureLog() {
            let logText = "üìñ „Åì„Çå„Åæ„Åß„ÅÆÂÜíÈô∫„ÅÆË®òÈå≤\n\n";
            let completedCount = 0;
            let pendingCount = 0;
            
            for (let i = 1; i <= TOTAL_STAGES; i++) {
                const status = userProgress[i];
                if (status === 'completed') {
                    logText += `„Çπ„ÉÜ„Éº„Ç∏${i}: ${stageStaticData[i].title} - ‚úÖ „ÇØ„É™„Ç¢Ê∏à„Åø\n`;
                    completedCount++;
                } else if (status === 'current') {
                    logText += `„Çπ„ÉÜ„Éº„Ç∏${i}: ${stageStaticData[i].title} - üéØ ÊåëÊà¶‰∏≠\n`;
                } else if (status === 'pending_approval') {
                    logText += `„Çπ„ÉÜ„Éº„Ç∏${i}: ${stageStaticData[i].title} - ‚è≥ ÊâøË™çÂæÖ„Å°\n`;
                    pendingCount++;
                }
            }
            
            if (completedCount === 0 && !Object.values(userProgress).some(s => s === 'current' || s === 'pending_approval')) {
                logText += '„Åæ„Å†ÂÜíÈô∫„ÅØÂßã„Åæ„Å£„Åü„Å∞„Åã„Çä„Åß„ÅôÔºÅ';
            }
            
            if (pendingCount > 0) {
                logText += `\n‚è≥ ${pendingCount}ÂÄã„ÅÆ„ÇØ„Ç®„Çπ„Éà„ÅåÊâøË™çÂæÖ„Å°„Åß„Åô`;
            }
            
            alert(logText);
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // „Éï„Ç°„Ç§„É´„Éó„É≠„Éà„Ç≥„É´Ôºàfile://Ôºâ„Åß„ÅØServiceWorker„ÇíÁôªÈå≤„Åó„Å™„ÅÑ
                if (window.location.protocol === 'file:') {
                    console.log('ServiceWorker registration skipped: file protocol not supported');
                    return;
                }
                
                navigator.serviceWorker.register('sw.js')
                    .then(registration => { console.log('SW registered: ', registration.scope); })
                    .catch(registrationError => { console.log('SW registration failed: ', registrationError); });
            });
        }
    </script>
    
    <!-- „Éë„Éº„Ç∑„É£„É´„Ç§„É≥„ÇØ„É´„Éº„ÉâÊ©üËÉΩ -->
    <script src="js/include.js?v=20250619"></script>
    
    <!-- manifest.json„ÇíÂãïÁöÑ„Å´Ë™≠„ÅøËæº„ÇÄ -->
    <script>
    function loadManifestWhenReady() {
        // file://„Éó„É≠„Éà„Ç≥„É´„ÅÆÂ†¥Âêà„ÅØmanifest.json„ÇíË™≠„ÅøËæº„Åæ„Å™„ÅÑ
        if (window.location.protocol === 'file:') {
            console.log('Manifest loading skipped: file protocol not supported');
            return;
        }
        
        // HTTP/HTTPS„ÅÆÂ†¥Âêà„ÅÆ„Åømanifest.json„ÇíË™≠„ÅøËæº„ÇÄ
        if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = 'manifest.json?v=20250619';
            document.head.appendChild(link);
        }
    }
    loadManifestWhenReady();
    </script>
    
    <!-- Supabase„É©„Ç§„Éñ„É©„É™„ÅÆË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´auth.js„ÇíË™≠„ÅøËæº„ÇÄ -->
    <script>
        function loadAuthWhenReady() {
            if (window.supabase && window.supabase.createClient) {
                const script = document.createElement('script');
                script.src = 'js/auth.js?v=20250619';
                document.body.appendChild(script);
            } else {
                setTimeout(loadAuthWhenReady, 100);
            }
        }
        loadAuthWhenReady();
    </script>
    
    <!-- Ê®™ÁîªÈù¢Âº∑Âà∂Ë°®Á§∫Ê©üËÉΩ -->
    <script>
    // Ê®™ÁîªÈù¢Âº∑Âà∂Ë°®Á§∫Ê©üËÉΩ
    function initLandscapeMode() {
        // „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥„Åã„Å©„ÅÜ„Åã„ÅÆÂà§ÂÆö
        function isMobileDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const mobileKeywords = ['mobile', 'android', 'iphone', 'ipad', 'ipod', 'blackberry', 'windows phone'];
            return mobileKeywords.some(keyword => userAgent.includes(keyword)) || 
                   (window.innerWidth <= 770 && 'ontouchstart' in window);
        }
        
        // ÁîªÈù¢„ÅÆÂêë„Åç„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶Ë°®Á§∫„ÇíÂàá„ÇäÊõø„Åà„Çã
        function checkOrientation() {
            const rotationNotice = document.querySelector('.rotation-notice');
            const isLandscape = window.innerHeight < window.innerWidth;
            const isMobile = isMobileDevice();
            
            if (isMobile && !isLandscape) {
                // „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥„ÅßÁ∏¶ÁîªÈù¢„ÅÆÂ†¥Âêà
                rotationNotice.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            } else {
                // Ê®™ÁîªÈù¢„Åæ„Åü„ÅØ„Éá„Çπ„ÇØ„Éà„ÉÉ„Éó„ÅÆÂ†¥Âêà
                rotationNotice.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }
        
        // ÂàùÊúü„ÉÅ„Çß„ÉÉ„ÇØ
        checkOrientation();
        
        // ÁîªÈù¢ÂõûËª¢„Éª„É™„Çµ„Ç§„Ç∫ÊôÇ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        window.addEventListener('orientationchange', () => {
            setTimeout(checkOrientation, 100); // Â∞ë„ÅóÈÅÖ„Çâ„Åõ„Å¶Ê≠£Á¢∫„Å™ÂÄ§„ÇíÂèñÂæó
        });
        
        window.addEventListener('resize', checkOrientation);
        
        // VisibilityChange „Ç§„Éô„É≥„Éà„Åß„ÇÇ„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç¢„Éó„É™Âàá„ÇäÊõø„ÅàÊôÇ„Å™„Å©Ôºâ
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                setTimeout(checkOrientation, 100);
            }
        });
    }
    
    // ÂàùÊúüÂåñ
    document.addEventListener('DOMContentLoaded', initLandscapeMode);
    </script>
</body>
</html>